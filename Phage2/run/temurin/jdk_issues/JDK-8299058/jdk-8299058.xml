<!-- 
RSS generated by JIRA (9.12.27#9120027-sha1:edc4490121e366e9e7bd2213d532dbe7e028fc5d) at Tue Sep 30 12:24:41 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>Java Bug System</title>
    <link>https://bugs.openjdk.org</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-us</language>    <build-info>
        <version>9.12.27</version>
        <build-number>9120027</build-number>
        <build-date>02-09-2025</build-date>
    </build-info>


<item>
            <title>[JDK-8299058] AssertionError in sun.net.httpserver.ServerImpl when connection is idle</title>
                <link>https://bugs.openjdk.org/browse/JDK-8299058</link>
                <project id="10100" key="JDK">JDK</project>
                    <description>ADDITIONAL SYSTEM INFORMATION :&lt;br/&gt;
Debian 4.14.295 x86_64 GNU/Linux&lt;br/&gt;
Adoptium OpenJDK 17.0.5+8&lt;br/&gt;
&lt;br/&gt;
A DESCRIPTION OF THE PROBLEM :&lt;br/&gt;
Since upgrading from Adoptium 17.0.4+8 to 17.0.5+8, we started observing this AssertionError in our test environment which has assertions enabled.&lt;br/&gt;
&lt;br/&gt;
java.lang.AssertionError: State is not REQUEST (IDLE)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at sun.net.httpserver.ServerImpl.requestCompleted(ServerImpl.java:967) ~[jdk.httpserver:?]&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at sun.net.httpserver.ServerImpl$Exchange.run(ServerImpl.java:743) ~[jdk.httpserver:?]&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1136) ~[?:?]&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:635) ~[?:?]&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at java.lang.Thread.run(Thread.java:833) [?:?] &lt;br/&gt;
&lt;br/&gt;
This happens pretty frequently since the upgrade, but we haven&amp;#39;t been able to create a standalone reproduction script yet. I didn&amp;#39;t see any other relevant information or logs or information related to the failure.&lt;br/&gt;
&lt;br/&gt;
I noticed a recent change in JDK-8286918 in ServerImpl where this assertion was raised, but haven&amp;#39;t been able to identify any specific changes that could be responsible&lt;br/&gt;
&lt;a href=&quot;https://github.com/openjdk/jdk17u-dev/commit/ff5418eff8c07be96005ca0d8477436643cc14dd&quot;&gt;https://github.com/openjdk/jdk17u-dev/commit/ff5418eff8c07be96005ca0d8477436643cc14dd&lt;/a&gt;&lt;br/&gt;
&lt;br/&gt;
REGRESSION : Last worked in version 17&lt;br/&gt;
&lt;br/&gt;
STEPS TO FOLLOW TO REPRODUCE THE PROBLEM :&lt;br/&gt;
Unable to reproduce intentionally yet&lt;br/&gt;
&lt;br/&gt;
&lt;br/&gt;
FREQUENCY : often&lt;br/&gt;
&lt;br/&gt;
&lt;br/&gt;
</description>
                <environment></environment>
        <key id="5089989">JDK-8299058</key>
            <summary>AssertionError in sun.net.httpserver.ServerImpl when connection is idle</summary>
                <type id="1" iconUrl="https://bugs.openjdk.org/secure/viewavatar?size=xsmall&amp;avatarId=14703&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://bugs.openjdk.org/images/jbsImages/p3.png">P3</priority>
                        <status id="5" iconUrl="https://bugs.openjdk.org/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="success"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="djelinski">Daniel Jelinski</assignee>
                                    <reporter username="webbuggrp">Webbug Group</reporter>
                        <labels>
                            <label>additional-information-received</label>
                            <label>amazon-interest</label>
                            <label>dcsaw</label>
                            <label>jdk11u-fix-request</label>
                            <label>jdk11u-fix-yes</label>
                            <label>jdk17u-fix-request</label>
                            <label>jdk17u-fix-yes</label>
                            <label>jdk21u-fix-request</label>
                            <label>jdk21u-fix-yes</label>
                            <label>noreg-hard</label>
                            <label>regression</label>
                            <label>reproducer-no</label>
                            <label>webbug</label>
                    </labels>
                <created>Sat, 17 Dec 2022 17:50:17 -0800</created>
                <updated>Mon, 22 Jul 2024 03:53:51 -0700</updated>
                            <resolved>Tue, 31 Oct 2023 08:55:28 -0700</resolved>
                                    <version>8</version>
                    <version>11</version>
                    <version>17</version>
                    <version>19</version>
                    <version>20</version>
                    <version>21</version>
                                    <fixVersion>22</fixVersion>
                                    <component>core-libs</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="14691265" author="mbaesken" created="Fri, 19 Jul 2024 07:23:28 -0700"  >jdk11u-dev backport request&lt;br/&gt;
I would like to have the patch in OpenJDK 11u-dev, because of parity with Oracle JDK. The backport is clean (when backported from jdk17u-dev) and low risk.</comment>
                            <comment id="14691168" author="roboduke" created="Fri, 19 Jul 2024 00:36:24 -0700"  >A pull request was submitted for review.&lt;br/&gt;
Branch: master&lt;br/&gt;
URL: &lt;a href=&quot;https://git.openjdk.org/jdk11u-dev/pull/2867&quot;&gt;https://git.openjdk.org/jdk11u-dev/pull/2867&lt;/a&gt;&lt;br/&gt;
Date: 2024-07-19 07:30:43 +0000</comment>
                            <comment id="14690502" author="mbaesken" created="Wed, 17 Jul 2024 00:17:15 -0700"  >jdk17u-dev backport request&lt;br/&gt;
I would like to have the patch in OpenJDK 17u-dev, because of parity with Oracle JDK. The backport is clean (but needs small manual adjustment because we still need in 17 the import of &amp;#39;Iterator&amp;#39;) and low risk.</comment>
                            <comment id="14690063" author="roboduke" created="Tue, 16 Jul 2024 04:54:20 -0700"  >A pull request was submitted for review.&lt;br/&gt;
Branch: master&lt;br/&gt;
URL: &lt;a href=&quot;https://git.openjdk.org/jdk17u-dev/pull/2719&quot;&gt;https://git.openjdk.org/jdk17u-dev/pull/2719&lt;/a&gt;&lt;br/&gt;
Date: 2024-07-16 11:49:43 +0000</comment>
                            <comment id="14688979" author="mbaesken" created="Thu, 11 Jul 2024 00:07:30 -0700"  >jdk21u-dev backport request&lt;br/&gt;
I would like to have the patch in OpenJDK 21u-dev, because of parity with Oracle JDK.  The backport is clean and low risk.</comment>
                            <comment id="14688612" author="roboduke" created="Wed, 10 Jul 2024 07:09:35 -0700"  >A pull request was submitted for review.&lt;br/&gt;
Branch: master&lt;br/&gt;
URL: &lt;a href=&quot;https://git.openjdk.org/jdk21u-dev/pull/833&quot;&gt;https://git.openjdk.org/jdk21u-dev/pull/833&lt;/a&gt;&lt;br/&gt;
Date: 2024-07-10 14:02:30 +0000</comment>
                            <comment id="14688589" author="jpai" created="Wed, 10 Jul 2024 06:14:02 -0700"  >Hello Matthias [~mbaesken], this fix has been backported to 17 and 21 too. The corresponding backport JBS issues were unintentionally marked private. That has now been addressed and you will notice the backport links for 17 and 21 too.</comment>
                            <comment id="14688562" author="mbaesken" created="Wed, 10 Jul 2024 05:03:44 -0700"  >[~djelinksi] I see backports to 11 and 8, but not to e.g. 17.  Any idea why this is as it is ? Fix version is 22 so I wonder what to do with LTS releases like 17,21 ?</comment>
                            <comment id="14622452" author="dukebot" created="Tue, 31 Oct 2023 08:55:27 -0700"  >Changeset: 47624f6f&lt;br/&gt;
Author:    Daniel Jeli&#324;ski &amp;lt;&lt;a href=&apos;mailto:djelinski@openjdk.org&apos;&gt;djelinski@openjdk.org&lt;/a&gt;&amp;gt;&lt;br/&gt;
Date:      2023-10-31 15:53:28 +0000&lt;br/&gt;
URL:       &lt;a href=&quot;https://git.openjdk.org/jdk/commit/47624f6fc699aa66c58587460ce7f39fce5a86c7&quot;&gt;https://git.openjdk.org/jdk/commit/47624f6fc699aa66c58587460ce7f39fce5a86c7&lt;/a&gt;&lt;br/&gt;
</comment>
                            <comment id="14621748" author="roboduke" created="Fri, 27 Oct 2023 09:55:36 -0700"  >A pull request was submitted for review.&lt;br/&gt;
URL: &lt;a href=&quot;https://git.openjdk.org/jdk/pull/16366&quot;&gt;https://git.openjdk.org/jdk/pull/16366&lt;/a&gt;&lt;br/&gt;
Date: 2023-10-25 17:27:57 +0000</comment>
                            <comment id="14621664" author="JIRAUSER19825" created="Fri, 27 Oct 2023 08:34:40 -0700"  >What seems to happen here is that the server determines that the connection is idle for too long, and removes it from idle connections set. The server then proceeds to close the connection.&lt;br/&gt;
At the same time, the client decides to reuse the connection and sends a new request. Another thread on the server starts handling the request. The connection is no longer on the idle connection list, so the connection state is not changed to request [1]. Nonetheless, the server starts handling the connection [2]. The connection handler then checks the connection state and throws the assertion error.&lt;br/&gt;
&lt;br/&gt;
The problem itself has been there for a long time, but after JDK-8286918 it&amp;#39;s easier to hit; that change increased the distance between removing a connection from idleConnections [3] and closing it [4].&lt;br/&gt;
&lt;br/&gt;
[1] &lt;a href=&quot;https://github.com/openjdk/jdk17u-dev/blob/d7dd1f06727cc752c80fd71eee51a7cbe51528ef/src/jdk.httpserver/share/classes/sun/net/httpserver/ServerImpl.java#L520-L521&quot;&gt;https://github.com/openjdk/jdk17u-dev/blob/d7dd1f06727cc752c80fd71eee51a7cbe51528ef/src/jdk.httpserver/share/classes/sun/net/httpserver/ServerImpl.java#L520-L521&lt;/a&gt;&lt;br/&gt;
[2] &lt;a href=&quot;https://github.com/openjdk/jdk17u-dev/blob/d7dd1f06727cc752c80fd71eee51a7cbe51528ef/src/jdk.httpserver/share/classes/sun/net/httpserver/ServerImpl.java#L527&quot;&gt;https://github.com/openjdk/jdk17u-dev/blob/d7dd1f06727cc752c80fd71eee51a7cbe51528ef/src/jdk.httpserver/share/classes/sun/net/httpserver/ServerImpl.java#L527&lt;/a&gt;&lt;br/&gt;
[3] &lt;a href=&quot;https://github.com/openjdk/jdk17u-dev/blob/d7dd1f06727cc752c80fd71eee51a7cbe51528ef/src/jdk.httpserver/share/classes/sun/net/httpserver/ServerImpl.java#L996&quot;&gt;https://github.com/openjdk/jdk17u-dev/blob/d7dd1f06727cc752c80fd71eee51a7cbe51528ef/src/jdk.httpserver/share/classes/sun/net/httpserver/ServerImpl.java#L996&lt;/a&gt;&lt;br/&gt;
[4] &lt;a href=&quot;https://github.com/openjdk/jdk17u-dev/blob/d7dd1f06727cc752c80fd71eee51a7cbe51528ef/src/jdk.httpserver/share/classes/sun/net/httpserver/ServerImpl.java#L1014&quot;&gt;https://github.com/openjdk/jdk17u-dev/blob/d7dd1f06727cc752c80fd71eee51a7cbe51528ef/src/jdk.httpserver/share/classes/sun/net/httpserver/ServerImpl.java#L1014&lt;/a&gt;</comment>
                            <comment id="14620116" author="JIRAUSER19825" created="Mon, 23 Oct 2023 02:46:39 -0700"  >Possible duplicate of &lt;a href=&quot;https://bugs.openjdk.org/browse/JDK-8318442&quot; title=&quot;java/net/httpclient/ManyRequests2.java fails intermittently on Linux&quot; class=&quot;issue-link&quot; data-issue-key=&quot;JDK-8318442&quot;&gt;&lt;strike&gt;JDK-8318442&lt;/strike&gt;&lt;/a&gt;</comment>
                            <comment id="14546722" author="pnarayanaswa" created="Mon, 19 Dec 2022 20:42:45 -0800"  >Additional Information from submitter&lt;br/&gt;
===========================&lt;br/&gt;
One theory is that the recent changes made in 17.0.5 as part of JDK-8286918 &amp;quot;Better HttpServer service&amp;quot; made a change to change the state of a connection to &amp;quot;State.IDLE&amp;quot; immediately and there&amp;#39;s a race where the state could be State.REQUEST in &amp;quot;ServerImpl#requestCompleted&amp;quot; and then shortly after timeout and become IDLE.&lt;br/&gt;
&lt;br/&gt;
The assertion detects the IDLE connection raises the error. Since it exclusively expects it to be State.REQUEST. Previously this connection would be cleaned up and closed &lt;br/&gt;
&lt;br/&gt;
Connection state is changed in &amp;quot;markIdle&amp;quot;&lt;br/&gt;
&lt;br/&gt;
&amp;nbsp;void markIdle(HttpConnection c) {&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;c.idleStartTime = System.currentTimeMillis();&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;c.setState(State.IDLE); &amp;lt;-----------&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;idleConnections.add(c);&lt;br/&gt;
&amp;nbsp;}&lt;br/&gt;
&lt;br/&gt;
this is called from this method here, which was changed as part of JDK-8286918 where it previously did not change the connection state directly&lt;br/&gt;
&lt;br/&gt;
&amp;nbsp;try {&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;SocketChannel chan = c.getChannel();&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;chan.configureBlocking (false);&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;SelectionKey key = chan.register (selector, SelectionKey.OP_READ);&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;key.attach (c);&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;c.selectionKey = key;&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;markIdle(c); &amp;lt;---------------------------------&lt;br/&gt;
&amp;nbsp;} catch (IOException e) {&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;dprint(e);&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;logger.log (Level.TRACE, &amp;quot;Dispatcher(8)&amp;quot;, e);&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;c.close();&lt;br/&gt;
&amp;nbsp;}&lt;br/&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10200">
                    <name>Backport</name>
                                            <outwardlinks description="backported by">
                                        <issuelink>
            <issuekey id="5114398">JDK-8319788</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="5114400">JDK-8319790</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="5132288">JDK-8334637</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="5132289">JDK-8334638</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="5134141">JDK-8336286</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="5134623">JDK-8336727</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="5134823">JDK-8336889</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10002">
                    <name>Duplicate</name>
                                            <outwardlinks description="duplicates">
                                        <issuelink>
            <issuekey id="5112753">JDK-8318442</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10003">
                    <name>Relates</name>
                                            <outwardlinks description="relates to">
                                                        </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_10000" key="com.atlassian.jira.plugin.system.customfieldtypes:multiselect">
                        <customfieldname>CPU</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="17008"><![CDATA[generic]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_11700" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_10600" key="com.oracle.jira.javabugsystem-jira-plugin:jbs-fixedBackportedCustomfield">
                        <customfieldname>Fixed</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_10004" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Introduced In Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="22027">17.0.5</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_10005" key="com.atlassian.jira.plugin.system.customfieldtypes:multiselect">
                        <customfieldname>OS</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="17010"><![CDATA[generic]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_11100" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2zo4z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_11004" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_10006" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Resolved In Build</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="17415"><![CDATA[b22]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_10008" key="com.oracle.jira.jira-subcomponent-plugin:oracle-subComponentField">
                        <customfieldname>Subcomponent</customfieldname>
                        <customfieldvalues>
                             <customfieldvalue key="193"><![CDATA[java.net]]></customfieldvalue> 
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_10601" key="com.oracle.jira.javabugsystem-jira-plugin:jbs-targetBackportedCustomfield">
                        <customfieldname>Targeted</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>