<!-- 
RSS generated by JIRA (9.12.27#9120027-sha1:edc4490121e366e9e7bd2213d532dbe7e028fc5d) at Tue Sep 30 18:51:04 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>Java Bug System</title>
    <link>https://bugs.openjdk.org</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-us</language>    <build-info>
        <version>9.12.27</version>
        <build-number>9120027</build-number>
        <build-date>02-09-2025</build-date>
    </build-info>


<item>
            <title>[JDK-8306734] Shenandoah: Missing barriers on deoptimization path</title>
                <link>https://bugs.openjdk.org/browse/JDK-8306734</link>
                <project id="10100" key="JDK">JDK</project>
                    <description>Reported here:&lt;br/&gt;
&amp;nbsp;&lt;a href=&quot;https://mail.openjdk.org/pipermail/shenandoah-dev/2023-April/019033.html&quot;&gt;https://mail.openjdk.org/pipermail/shenandoah-dev/2023-April/019033.html&lt;/a&gt;&lt;br/&gt;
&lt;br/&gt;
% CONF=macosx-aarch64-server-fastdebug make images test TEST=gc/shenandoah/compiler/TestReferenceCAS.java TEST_VM_OPTS=&amp;quot;-Xcomp&amp;quot;&lt;br/&gt;
&lt;br/&gt;
#&lt;br/&gt;
# A fatal error has been detected by the Java Runtime Environment:&lt;br/&gt;
#&lt;br/&gt;
#  Internal Error (/Users/shipilev/Work/shipilev-jdk/src/hotspot/share/gc/shenandoah/shenandoahBarrierSet.inline.hpp:246), pid=67189, tid=8707&lt;br/&gt;
#  Error: Shenandoah assert_not_in_cset failed; Object should not be in collection set&lt;br/&gt;
&lt;br/&gt;
Referenced from:&lt;br/&gt;
&amp;nbsp;&amp;nbsp;interior location: 0x0000000280100158&lt;br/&gt;
&amp;nbsp;&amp;nbsp;inside Java heap&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;not in collection set&lt;br/&gt;
&amp;nbsp;&amp;nbsp;region: |    2|R  |BTE    280100000,    28017fd88,    280180000|TAMS    280100000|UWM    280100000|U   511K|T   511K|G     0B|S     0B|L     0B|CP   0&lt;br/&gt;
&lt;br/&gt;
Object:&lt;br/&gt;
&amp;nbsp;&amp;nbsp;0x00000002e6580f78 - klass 0x0000000800006340 java.security.CodeSource&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;not allocated after mark start&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;not after update watermark&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;marked strong&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;not marked weak&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;in collection set&lt;br/&gt;
&amp;nbsp;&amp;nbsp;mark: marked(0x00000002e66014e3)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;region: | 3275|CS |BTE    2e6580000,    2e6600000,    2e6600000|TAMS    2e6600000|UWM    2e6600000|U   512K|T     0B|G   511K|S   184B|L   475K|CP   0&lt;br/&gt;
&lt;br/&gt;
Forwardee:&lt;br/&gt;
&amp;nbsp;&amp;nbsp;0x00000002e66014e0 - klass 0x0000000800006340 java.security.CodeSource&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;allocated after mark start&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;not after update watermark&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;marked strong&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;marked weak&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;not in collection set&lt;br/&gt;
&amp;nbsp;&amp;nbsp;mark: mark(is_neutral no_hash age=0)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;region: | 3276|R  |BTE    2e6600000,    2e6628dc8,    2e6680000|TAMS    2e6600000|UWM    2e6628dc8|U   163K|T     0B|G   163K|S   184B|L     0B|CP   0&lt;br/&gt;
&lt;br/&gt;
Stack trace suggests we call this from deopt:&lt;br/&gt;
&lt;br/&gt;
---------------  T H R E A D  ---------------&lt;br/&gt;
&lt;br/&gt;
Current thread (0x000000013800a210):  JavaThread &amp;quot;main&amp;quot; [_thread_in_Java, id=8707, stack(0x000000016dc7c000,0x000000016de7f000)]&lt;br/&gt;
&lt;br/&gt;
Stack: [0x000000016dc7c000,0x000000016de7f000],  sp=0x000000016de7a3a0,  free space=2040k&lt;br/&gt;
Native frames: (J=compiled Java code, j=interpreted, Vv=VM code, C=native code)&lt;br/&gt;
V  [libjvm.dylib+0x113b1cc]  VMError::report_and_die(int, char const*, char const*, char*, Thread*, unsigned char*, void*, void*, char const*, int, unsigned long)+0x564  (shenandoahBarrierSet.inline.hpp:246)&lt;br/&gt;
V  [libjvm.dylib+0x113b9e8]  VMError::report_and_die(Thread*, char const*, int, unsigned long, VMErrorType, char const*, char*)+0x0&lt;br/&gt;
V  [libjvm.dylib+0x52eb7c]  print_error_for_unit_test(char const*, char const*, char*)+0x0&lt;br/&gt;
V  [libjvm.dylib+0x52eb10]  report_vm_error(char const*, int, char const*, char const*, ...)+0x0&lt;br/&gt;
V  [libjvm.dylib+0xea3818]  ShenandoahAsserts::print_failure(ShenandoahAsserts::SafeLevel, oop, void*, oop, char const*, char const*, char const*, int)+0x2e0&lt;br/&gt;
V  [libjvm.dylib+0xea54c0]  ShenandoahAsserts::assert_not_in_cset(void*, oop, char const*, int)+0x1e8&lt;br/&gt;
V  [libjvm.dylib+0x40cd58]  void ShenandoahBarrierSet::AccessBarrier&amp;lt;286790ull, ShenandoahBarrierSet&amp;gt;::oop_store_common&amp;lt;oop&amp;gt;(oop*, oop)+0x178&lt;br/&gt;
V  [libjvm.dylib+0x40cb40]  void ShenandoahBarrierSet::AccessBarrier&amp;lt;286790ull, ShenandoahBarrierSet&amp;gt;::oop_store_in_heap&amp;lt;oop&amp;gt;(oop*, oop)+0x180&lt;br/&gt;
V  [libjvm.dylib+0x7b2170]  AccessInternal::PostRuntimeDispatch&amp;lt;ShenandoahBarrierSet::AccessBarrier&amp;lt;286790ull, ShenandoahBarrierSet&amp;gt;, (AccessInternal::BarrierType)1, 286790ull&amp;gt;::oop_access_barrier(oop, long, oop)+0xb0&lt;br/&gt;
V  [libjvm.dylib+0x889120]  std::__1::enable_if&amp;lt;!HasDecorator&amp;lt;286790ull, AS_RAW&amp;gt;::value, void&amp;gt;::type AccessInternal::PreRuntimeDispatch::store_at&amp;lt;286790ull, oop&amp;gt;(oop, long, oop)+0xe0&lt;br/&gt;
V  [libjvm.dylib+0x7b1d30]  void AccessInternal::store_at&amp;lt;262148ull, oop&amp;gt;(oop, long, oop)+0x90&lt;br/&gt;
V  [libjvm.dylib+0xcec4b0]  void Access&amp;lt;262144ull&amp;gt;::oop_store_at&amp;lt;oop&amp;gt;(oop, long, oop)+0x90&lt;br/&gt;
V  [libjvm.dylib+0x55d820]  Deoptimization::reassign_fields(frame*, RegisterMap*, GrowableArray&amp;lt;ScopeValue*&amp;gt;*, bool, bool)+0x2604&lt;br/&gt;
V  [libjvm.dylib+0x557434]  rematerialize_objects(JavaThread*, int, CompiledMethod*, frame&amp;amp;, RegisterMap&amp;amp;, GrowableArray&amp;lt;compiledVFrame*&amp;gt;*, bool&amp;amp;)+0x368&lt;br/&gt;
V  [libjvm.dylib+0x55607c]  Deoptimization::fetch_unroll_info_helper(JavaThread*, int)+0x2d4&lt;br/&gt;
V  [libjvm.dylib+0x561b94]  Deoptimization::uncommon_trap(JavaThread*, int, int)+0xa4&lt;br/&gt;
Java frames: (J=compiled Java code, j=interpreted, Vv=VM code)&lt;br/&gt;
v  ~UncommonTrapBlob 0x000000010dd4916c&lt;br/&gt;
J 2604 c2 java.security.SecureClassLoader$1.apply(Ljava/security/SecureClassLoader$CodeSourceKey;)Ljava/security/ProtectionDomain; &lt;a href=&apos;mailto:java.base@21-internal&apos;&gt;java.base@21-internal&lt;/a&gt; (71 bytes) @ 0x000000010e1bd7ec [0x000000010e1bd700+0x00000000000000ec]&lt;br/&gt;
j  java.security.SecureClassLoader$1.apply(Ljava/lang/Object;)Ljava/lang/Object;+5 &lt;a href=&apos;mailto:java.base@21-internal&apos;&gt;java.base@21-internal&lt;/a&gt;&lt;br/&gt;
J 1959 c2 java.util.concurrent.ConcurrentHashMap.computeIfAbsent(Ljava/lang/Object;Ljava/util/function/Function;)Ljava/lang/Object; &lt;a href=&apos;mailto:java.base@21-internal&apos;&gt;java.base@21-internal&lt;/a&gt; (576 bytes) @ 0x000000010de79434 [0x000000010de78fc0+0x0000000000000474]&lt;br/&gt;
j  java.security.SecureClassLoader.getProtectionDomain(Ljava/security/CodeSource;)Ljava/security/ProtectionDomain;+28 &lt;a href=&apos;mailto:java.base@21-internal&apos;&gt;java.base@21-internal&lt;/a&gt;&lt;br/&gt;
J 2599 c2 java.security.SecureClassLoader.defineClass(Ljava/lang/String;[BIILjava/security/CodeSource;)Ljava/lang/Class; &lt;a href=&apos;mailto:java.base@21-internal&apos;&gt;java.base@21-internal&lt;/a&gt; (16 bytes) @ 0x000000010e1bad3c [0x000000010e1bacc0+0x000000000000007c]&lt;br/&gt;
j  jdk.internal.loader.BuiltinClassLoader.defineClass(Ljava/lang/String;Ljdk/internal/loader/Resource;)Ljava/lang/Class;+117 &lt;a href=&apos;mailto:java.base@21-internal&apos;&gt;java.base@21-internal&lt;/a&gt;&lt;br/&gt;
j  jdk.internal.loader.BuiltinClassLoader.findClassOnClassPathOrNull(Ljava/lang/String;)Ljava/lang/Class;+37 &lt;a href=&apos;mailto:java.base@21-internal&apos;&gt;java.base@21-internal&lt;/a&gt;&lt;br/&gt;
j  jdk.internal.loader.BuiltinClassLoader.loadClassOrNull(Ljava/lang/String;Z)Ljava/lang/Class;+111 &lt;a href=&apos;mailto:java.base@21-internal&apos;&gt;java.base@21-internal&lt;/a&gt;&lt;br/&gt;
J 2010 c2 jdk.internal.loader.ClassLoaders$AppClassLoader.loadClass(Ljava/lang/String;Z)Ljava/lang/Class; &lt;a href=&apos;mailto:java.base@21-internal&apos;&gt;java.base@21-internal&lt;/a&gt; (40 bytes) @ 0x000000010de0ffac [0x000000010de0ff40+0x000000000000006c]&lt;br/&gt;
J 2009 c2 java.lang.ClassLoader.loadClass(Ljava/lang/String;)Ljava/lang/Class; &lt;a href=&apos;mailto:java.base@21-internal&apos;&gt;java.base@21-internal&lt;/a&gt; (7 bytes) @ 0x000000010de106b8 [0x000000010de10640+0x0000000000000078]&lt;br/&gt;
v  ~StubRoutines::call_stub 0x000000010dc7016c&lt;br/&gt;
J 759  java.lang.Class.forName0(Ljava/lang/String;ZLjava/lang/ClassLoader;Ljava/lang/Class;)Ljava/lang/Class; &lt;a href=&apos;mailto:java.base@21-internal&apos;&gt;java.base@21-internal&lt;/a&gt; (0 bytes) @ 0x000000010debf498 [0x000000010debf3c0+0x00000000000000d8]&lt;br/&gt;
J 758 c2 java.lang.Class.forName(Ljava/lang/String;ZLjava/lang/ClassLoader;Ljava/lang/Class;)Ljava/lang/Class; &lt;a href=&apos;mailto:java.base@21-internal&apos;&gt;java.base@21-internal&lt;/a&gt; (41 bytes) @ 0x000000010debfabc [0x000000010debfa40+0x000000000000007c]&lt;br/&gt;
J 2008 c2 sun.launcher.LauncherHelper.loadMainClass(ILjava/lang/String;)Ljava/lang/Class; &lt;a href=&apos;mailto:java.base@21-internal&apos;&gt;java.base@21-internal&lt;/a&gt; (277 bytes) @ 0x000000010e0b3264 [0x000000010e0b31c0+0x00000000000000a4]&lt;br/&gt;
J 2007 c2 sun.launcher.LauncherHelper.checkAndLoadMain(ZILjava/lang/String;)Ljava/lang/Class; &lt;a href=&apos;mailto:java.base@21-internal&apos;&gt;java.base@21-internal&lt;/a&gt; (85 bytes) @ 0x000000010de4b9d0 [0x000000010de4b940+0x0000000000000090]&lt;br/&gt;
v  ~StubRoutines::call_stub 0x000000010dc7016c&lt;br/&gt;
&lt;br/&gt;
</description>
                <environment></environment>
        <key id="5099246">JDK-8306734</key>
            <summary>Shenandoah: Missing barriers on deoptimization path</summary>
                <type id="1" iconUrl="https://bugs.openjdk.org/secure/viewavatar?size=xsmall&amp;avatarId=14703&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://bugs.openjdk.org/images/jbsImages/p3.png">P3</priority>
                        <status id="5" iconUrl="https://bugs.openjdk.org/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="success"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="shade">Aleksey Shipilev</assignee>
                                    <reporter username="shade">Aleksey Shipilev</reporter>
                        <labels>
                            <label>amazon-interest</label>
                            <label>gc-shenandoah</label>
                            <label>jdk20u-fix-SQE-ok</label>
                            <label>jdk20u-fix-request</label>
                            <label>jdk20u-fix-yes</label>
                    </labels>
                <created>Mon, 24 Apr 2023 03:26:18 -0700</created>
                <updated>Mon, 15 May 2023 18:15:43 -0700</updated>
                            <resolved>Tue, 25 Apr 2023 11:49:10 -0700</resolved>
                                    <version>20</version>
                    <version>21</version>
                                    <fixVersion>21</fixVersion>
                                    <component>hotspot</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="14576997" author="shade" created="Wed, 26 Apr 2023 06:04:13 -0700"  >Fix Request (20u)&lt;br/&gt;
&lt;br/&gt;
Fixes a fatal bug (missing GC barrier) in Shenandoah. Recent regression. Patch applies cleanly, tests pass.</comment>
                            <comment id="14576963" author="roboduke" created="Wed, 26 Apr 2023 04:01:42 -0700"  >A pull request was submitted for review.&lt;br/&gt;
URL: &lt;a href=&quot;https://git.openjdk.org/jdk20u/pull/64&quot;&gt;https://git.openjdk.org/jdk20u/pull/64&lt;/a&gt;&lt;br/&gt;
Date: 2023-04-26 10:54:11 +0000</comment>
                            <comment id="14576774" author="dukebot" created="Tue, 25 Apr 2023 11:49:09 -0700"  >Changeset: 28829f30&lt;br/&gt;
Author:    Aleksey Shipilev &amp;lt;&lt;a href=&apos;mailto:shade@openjdk.org&apos;&gt;shade@openjdk.org&lt;/a&gt;&amp;gt;&lt;br/&gt;
Date:      2023-04-25 18:46:55 +0000&lt;br/&gt;
URL:       &lt;a href=&quot;https://git.openjdk.org/jdk/commit/28829f308fe6314388c9a47b91273bcf81eb806c&quot;&gt;https://git.openjdk.org/jdk/commit/28829f308fe6314388c9a47b91273bcf81eb806c&lt;/a&gt;&lt;br/&gt;
</comment>
                            <comment id="14576099" author="roboduke" created="Mon, 24 Apr 2023 08:54:46 -0700"  >A pull request was submitted for review.&lt;br/&gt;
URL: &lt;a href=&quot;https://git.openjdk.org/jdk/pull/13613&quot;&gt;https://git.openjdk.org/jdk/pull/13613&lt;/a&gt;&lt;br/&gt;
Date: 2023-04-24 11:44:16 +0000</comment>
                            <comment id="14576020" author="shade" created="Mon, 24 Apr 2023 04:01:28 -0700"  >AFAICS, Loom integration (&lt;a href=&quot;https://bugs.openjdk.org/browse/JDK-8284161&quot; title=&quot;Implementation of Virtual Threads (Preview)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;JDK-8284161&quot;&gt;&lt;strike&gt;JDK-8284161&lt;/strike&gt;&lt;/a&gt;) moved the Shenandoah block `StackValue::create_stack_value` that we added to avoid exposing bad oops during the deopt (&lt;a href=&quot;https://bugs.openjdk.org/browse/JDK-8224522&quot; title=&quot;Shenandoah should apply barriers on deoptimization&quot; class=&quot;issue-link&quot; data-issue-key=&quot;JDK-8224522&quot;&gt;&lt;strike&gt;JDK-8224522&lt;/strike&gt;&lt;/a&gt;). I think that was done to avoid interaction with barrier healing acting on derived pointer bases (?), so it employed the `NativeAccess::load_oop` trick to still call into GC barriers without healing. Then, the refactoring for ZGC (&lt;a href=&quot;https://bugs.openjdk.org/browse/JDK-8296875&quot; title=&quot;Generational ZGC: Refactor loom code&quot; class=&quot;issue-link&quot; data-issue-key=&quot;JDK-8296875&quot;&gt;&lt;strike&gt;JDK-8296875&lt;/strike&gt;&lt;/a&gt;) redid these paths, but dropped the `NativeAccess::load_oop` completely, which exposed Shenandoah to a missing barrier.</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10200">
                    <name>Backport</name>
                                            <outwardlinks description="backported by">
                                        <issuelink>
            <issuekey id="5099793">JDK-8307151</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="5100972">JDK-8308128</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10003">
                    <name>Relates</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="4991157">JDK-8224522</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="5087381">JDK-8296875</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_11700" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_10600" key="com.oracle.jira.javabugsystem-jira-plugin:jbs-fixedBackportedCustomfield">
                        <customfieldname>Fixed</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_11100" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i318w3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_11004" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_10006" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Resolved In Build</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="17351"><![CDATA[b20]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_10008" key="com.oracle.jira.jira-subcomponent-plugin:oracle-subComponentField">
                        <customfieldname>Subcomponent</customfieldname>
                        <customfieldvalues>
                             <customfieldvalue key="209"><![CDATA[gc]]></customfieldvalue> 
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_10601" key="com.oracle.jira.javabugsystem-jira-plugin:jbs-targetBackportedCustomfield">
                        <customfieldname>Targeted</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>