<!-- 
RSS generated by JIRA (9.12.27#9120027-sha1:edc4490121e366e9e7bd2213d532dbe7e028fc5d) at Tue Sep 30 09:27:33 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>Java Bug System</title>
    <link>https://bugs.openjdk.org</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-us</language>    <build-info>
        <version>9.12.27</version>
        <build-number>9120027</build-number>
        <build-date>02-09-2025</build-date>
    </build-info>


<item>
            <title>[JDK-8310233] Fix THP detection on Linux</title>
                <link>https://bugs.openjdk.org/browse/JDK-8310233</link>
                <project id="10100" key="JDK">JDK</project>
                    <description>Today, if we use UseTransparentHugePages, we assume that the static hugepage detection we do is valid for THPs:&lt;br/&gt;
- that THPs use the page size (in hotspot used as &amp;quot;default large page size&amp;quot;) found in /proc/memlimit Hugepagesize)&lt;br/&gt;
- that THPs are enabled if that page size is &amp;gt;0.&lt;br/&gt;
&lt;br/&gt;
Both assumptions are incorrect. THPs are enabled depending on the mode in `/sys/kernel/mm/transparent_hugepage/enabled` (tri-state). And the pagesize used by khugepaged is the one set in `/sys/kernel/mm/transparent_hugepage/hpage_pmd_size`. The latter can differ from the default large page size on the system (e.g. static hugepage default size could be 1g, whereas THP hugepage size is 2m).&lt;br/&gt;
&lt;br/&gt;
-------------&lt;br/&gt;
&lt;br/&gt;
Example 1: System has THPs disabled, but static hugepages (1g, 2m) configured:&lt;br/&gt;
&lt;br/&gt;
```&lt;br/&gt;
&lt;a href=&apos;mailto:thomas@starfish&apos;&gt;thomas@starfish&lt;/a&gt; $ cat /sys/kernel/mm/transparent_hugepage/enabled&lt;br/&gt;
always madvise [never]&lt;br/&gt;
&lt;a href=&apos;mailto:thomas@starfish&apos;&gt;thomas@starfish&lt;/a&gt; $ cat /proc/meminfo | grep Hugepage&lt;br/&gt;
Hugepagesize:    1048576 kB&lt;br/&gt;
```&lt;br/&gt;
&lt;br/&gt;
We incorrectly assume THPs are enabled, and that THP page size is 1G (!), which we then proceed and use as heap page size, causing the heap size to be rounded up from 512m -&amp;gt; 1G:&lt;br/&gt;
&lt;br/&gt;
```&lt;br/&gt;
&lt;a href=&apos;mailto:thomas@starfish&apos;&gt;thomas@starfish&lt;/a&gt; $ ./images/jdk/bin/java -Xmx512m -XX:+UseLargePages -XX:+UseTransparentHugePages -Xlog:pagesize -version&lt;br/&gt;
[0.001s][info][pagesize] Using the default large page size: 1G&lt;br/&gt;
[0.001s][info][pagesize] Usable page sizes: 4k, 2M, 1G&lt;br/&gt;
...&lt;br/&gt;
[0.016s][info][pagesize] Heap:  min=1G max=1G base=0x00000000c0000000 size=1G page_size=1G&lt;br/&gt;
```&lt;br/&gt;
&lt;br/&gt;
----------&lt;br/&gt;
&lt;br/&gt;
Example 2: System has THPs enabled, but THP page size is just *2M*, whereas the system uses a static default hugepage size of *1G*:&lt;br/&gt;
&lt;br/&gt;
```&lt;br/&gt;
&lt;a href=&apos;mailto:thomas@starfish&apos;&gt;thomas@starfish&lt;/a&gt; $ cat /sys/kernel/mm/transparent_hugepage/enabled&lt;br/&gt;
always [madvise] never&lt;br/&gt;
&lt;a href=&apos;mailto:thomas@starfish&apos;&gt;thomas@starfish&lt;/a&gt; $ cat /sys/kernel/mm/transparent_hugepage/hpage_pmd_size &lt;br/&gt;
2097152&lt;br/&gt;
&lt;a href=&apos;mailto:thomas@starfish&apos;&gt;thomas@starfish&lt;/a&gt; $ cat /proc/meminfo | grep Hugepage&lt;br/&gt;
Hugepagesize:    1048576 kB&lt;br/&gt;
```&lt;br/&gt;
&lt;br/&gt;
WTHP page size is not correctly recognized as 2M. Instead, we again use 1G as page size for the heap:&lt;br/&gt;
&lt;br/&gt;
```&lt;br/&gt;
&lt;a href=&apos;mailto:thomas@starfish&apos;&gt;thomas@starfish&lt;/a&gt; $ ./images/jdk/bin/java -Xmx512m -XX:+UseLargePages -XX:+UseTransparentHugePages -Xlog:pagesize -version&lt;br/&gt;
[0.001s][info][pagesize] Using the default large page size: 1G&lt;br/&gt;
[0.001s][info][pagesize] Usable page sizes: 4k, 2M, 1G&lt;br/&gt;
...&lt;br/&gt;
[0.010s][info][pagesize] Heap:  min=1G max=1G base=0x00000000c0000000 size=1G page_size=1G&lt;br/&gt;
```&lt;br/&gt;
</description>
                <environment></environment>
        <key id="5103423">JDK-8310233</key>
            <summary>Fix THP detection on Linux</summary>
                <type id="1" iconUrl="https://bugs.openjdk.org/secure/viewavatar?size=xsmall&amp;avatarId=14703&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://bugs.openjdk.org/images/jbsImages/p4.png">P4</priority>
                        <status id="5" iconUrl="https://bugs.openjdk.org/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="success"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="stuefe">Thomas Stuefe</assignee>
                                    <reporter username="stuefe">Thomas Stuefe</reporter>
                        <labels>
                            <label>amazon-interest</label>
                            <label>jdk17u-fix-request</label>
                            <label>jdk17u-fix-yes</label>
                            <label>jdk21u-fix-SQE-ok</label>
                            <label>jdk21u-fix-request</label>
                            <label>jdk21u-fix-yes</label>
                            <label>large-pages</label>
                            <label>redhat-interest</label>
                            <label>sustaining</label>
                    </labels>
                <created>Fri, 16 Jun 2023 10:44:27 -0700</created>
                <updated>Tue, 5 Dec 2023 01:38:21 -0800</updated>
                            <resolved>Sun, 16 Jul 2023 21:57:52 -0700</resolved>
                                    <version>21</version>
                    <version>22</version>
                                    <fixVersion>22</fixVersion>
                                    <component>hotspot</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="14606760" author="stuefe" created="Fri, 25 Aug 2023 23:09:18 -0700"  >Fix Request 17u: &lt;br/&gt;
&lt;br/&gt;
(note: not for the October CPU; I will delay pushing this till after the fork).&lt;br/&gt;
&lt;br/&gt;
I would like to backport this to 17u since it is a pre-requisite for fixing &lt;a href=&quot;https://bugs.openjdk.org/browse/JDK-8312182&quot;&gt;https://bugs.openjdk.org/browse/JDK-8312182&lt;/a&gt; (&amp;quot;THPs cause huge RSS due to thread start timing issue&amp;quot;). &lt;br/&gt;
&lt;br/&gt;
The backport did not apply cleanly; however, there are no actual differences. The only change preventing cleanliness was the NULL-&amp;gt;nullptr change. &lt;br/&gt;
&lt;br/&gt;
Patch is tested (GHAs and personal tests with various THP settings) and reviewed (&lt;a href=&quot;https://github.com/openjdk/jdk17u-dev/pull/1694&quot;&gt;https://github.com/openjdk/jdk17u-dev/pull/1694&lt;/a&gt;).&lt;br/&gt;
&lt;br/&gt;
After this patch, we need two follow-up patches to correct errors in rare corner case scenarios (arm32 SBCs and building on windows inside WSL): &lt;br/&gt;
&lt;br/&gt;
- &lt;a href=&quot;https://bugs.openjdk.org/browse/JDK-8312394&quot; title=&quot;[linux] SIGSEGV if kernel was built without hugepage support&quot; class=&quot;issue-link&quot; data-issue-key=&quot;JDK-8312394&quot;&gt;&lt;strike&gt;JDK-8312394&lt;/strike&gt;&lt;/a&gt; [linux] SIGSEGV if kernel was built without hugepage support (&lt;a href=&quot;https://bugs.openjdk.org/browse/JDK-8312394&quot;&gt;https://bugs.openjdk.org/browse/JDK-8312394&lt;/a&gt;) &lt;br/&gt;
- &lt;a href=&quot;https://bugs.openjdk.org/browse/JDK-8312620&quot; title=&quot;WSL Linux build crashes after JDK-8310233&quot; class=&quot;issue-link&quot; data-issue-key=&quot;JDK-8312620&quot;&gt;&lt;strike&gt;JDK-8312620&lt;/strike&gt;&lt;/a&gt; WSL Linux build crashes after &lt;a href=&quot;https://bugs.openjdk.org/browse/JDK-8310233&quot; title=&quot;Fix THP detection on Linux&quot; class=&quot;issue-link&quot; data-issue-key=&quot;JDK-8310233&quot;&gt;&lt;strike&gt;JDK-8310233&lt;/strike&gt;&lt;/a&gt; (&lt;a href=&quot;https://bugs.openjdk.org/browse/JDK-8312620&quot;&gt;https://bugs.openjdk.org/browse/JDK-8312620&lt;/a&gt;) &lt;br/&gt;
&lt;br/&gt;
and I will prepare them too and line them up such that I can push them in short order.</comment>
                            <comment id="14606606" author="roboduke" created="Fri, 25 Aug 2023 05:06:23 -0700"  >A pull request was submitted for review.&lt;br/&gt;
URL: &lt;a href=&quot;https://git.openjdk.org/jdk17u-dev/pull/1694&quot;&gt;https://git.openjdk.org/jdk17u-dev/pull/1694&lt;/a&gt;&lt;br/&gt;
Date: 2023-08-25 10:55:00 +0000</comment>
                            <comment id="14606037" author="roboduke" created="Wed, 23 Aug 2023 01:27:41 -0700"  >A pull request was submitted for review.&lt;br/&gt;
URL: &lt;a href=&quot;https://git.openjdk.org/jdk11u-dev/pull/2086&quot;&gt;https://git.openjdk.org/jdk11u-dev/pull/2086&lt;/a&gt;&lt;br/&gt;
Date: 2023-08-17 14:50:49 +0000</comment>
                            <comment id="14606032" author="roboduke" created="Wed, 23 Aug 2023 01:25:32 -0700"  >A pull request was submitted for review.&lt;br/&gt;
URL: &lt;a href=&quot;https://git.openjdk.org/jdk17u-dev/pull/1679&quot;&gt;https://git.openjdk.org/jdk17u-dev/pull/1679&lt;/a&gt;&lt;br/&gt;
Date: 2023-08-21 12:47:15 +0000</comment>
                            <comment id="14605264" author="stuefe" created="Mon, 21 Aug 2023 02:24:28 -0700"  >Fix Request 21u:&lt;br/&gt;
&lt;br/&gt;
I would like to backport this to 21u since it is a pre-requisite for fixing &lt;a href=&quot;https://bugs.openjdk.org/browse/JDK-8312182&quot;&gt;https://bugs.openjdk.org/browse/JDK-8312182&lt;/a&gt; (&amp;quot;THPs cause huge RSS due to thread start timing issue&amp;quot;).&lt;br/&gt;
&lt;br/&gt;
The backport applies cleanly. The risk is small.&lt;br/&gt;
&lt;br/&gt;
After this patch, we need two follow-up patches to correct errors in rare corner case scenarios (arm32 SBCs and building on windows inside WSL):&lt;br/&gt;
&lt;br/&gt;
- &lt;a href=&quot;https://bugs.openjdk.org/browse/JDK-8312394&quot; title=&quot;[linux] SIGSEGV if kernel was built without hugepage support&quot; class=&quot;issue-link&quot; data-issue-key=&quot;JDK-8312394&quot;&gt;&lt;strike&gt;JDK-8312394&lt;/strike&gt;&lt;/a&gt; [linux] SIGSEGV if kernel was built without hugepage support (&lt;a href=&quot;https://bugs.openjdk.org/browse/JDK-8312394&quot;&gt;https://bugs.openjdk.org/browse/JDK-8312394&lt;/a&gt;)&lt;br/&gt;
- &lt;a href=&quot;https://bugs.openjdk.org/browse/JDK-8312620&quot; title=&quot;WSL Linux build crashes after JDK-8310233&quot; class=&quot;issue-link&quot; data-issue-key=&quot;JDK-8312620&quot;&gt;&lt;strike&gt;JDK-8312620&lt;/strike&gt;&lt;/a&gt; WSL Linux build crashes after &lt;a href=&quot;https://bugs.openjdk.org/browse/JDK-8310233&quot; title=&quot;Fix THP detection on Linux&quot; class=&quot;issue-link&quot; data-issue-key=&quot;JDK-8310233&quot;&gt;&lt;strike&gt;JDK-8310233&lt;/strike&gt;&lt;/a&gt; (&lt;a href=&quot;https://bugs.openjdk.org/browse/JDK-8312620&quot;&gt;https://bugs.openjdk.org/browse/JDK-8312620&lt;/a&gt;)&lt;br/&gt;
&lt;br/&gt;
and I will prepare and push them in short order (but obviously, this patch needs to be pushed first).&lt;br/&gt;
&lt;br/&gt;
</comment>
                            <comment id="14603977" author="roboduke" created="Tue, 15 Aug 2023 02:26:45 -0700"  >A pull request was submitted for review.&lt;br/&gt;
URL: &lt;a href=&quot;https://git.openjdk.org/jdk21u/pull/60&quot;&gt;https://git.openjdk.org/jdk21u/pull/60&lt;/a&gt;&lt;br/&gt;
Date: 2023-08-15 09:22:23 +0000</comment>
                            <comment id="14598300" author="JIRAUSER19825" created="Mon, 24 Jul 2023 12:55:57 -0700"  >After this change the WSL linux build crashes, see &lt;a href=&quot;https://bugs.openjdk.org/browse/JDK-8312620&quot; title=&quot;WSL Linux build crashes after JDK-8310233&quot; class=&quot;issue-link&quot; data-issue-key=&quot;JDK-8312620&quot;&gt;&lt;strike&gt;JDK-8312620&lt;/strike&gt;&lt;/a&gt;</comment>
                            <comment id="14597184" author="marchof" created="Wed, 19 Jul 2023 00:20:44 -0700"  >After this change the arm32 build crashes for me (when using the JVM), see &lt;a href=&quot;https://bugs.openjdk.org/browse/JDK-8312366&quot; title=&quot;[arm32] Build crashes after JDK-8310233&quot; class=&quot;issue-link&quot; data-issue-key=&quot;JDK-8312366&quot;&gt;&lt;strike&gt;JDK-8312366&lt;/strike&gt;&lt;/a&gt;.</comment>
                            <comment id="14596438" author="dukebot" created="Sun, 16 Jul 2023 21:57:51 -0700"  >Changeset: 37ca9024&lt;br/&gt;
Author:    Thomas Stuefe &amp;lt;&lt;a href=&apos;mailto:stuefe@openjdk.org&apos;&gt;stuefe@openjdk.org&lt;/a&gt;&amp;gt;&lt;br/&gt;
Date:      2023-07-17 04:56:10 +0000&lt;br/&gt;
URL:       &lt;a href=&quot;https://git.openjdk.org/jdk/commit/37ca9024ef59d99cae0bd7e25b2e6d3c1e085f97&quot;&gt;https://git.openjdk.org/jdk/commit/37ca9024ef59d99cae0bd7e25b2e6d3c1e085f97&lt;/a&gt;&lt;br/&gt;
</comment>
                            <comment id="14593232" author="roboduke" created="Sat, 1 Jul 2023 12:29:59 -0700"  >A pull request was submitted for review.&lt;br/&gt;
URL: &lt;a href=&quot;https://git.openjdk.org/jdk/pull/14739&quot;&gt;https://git.openjdk.org/jdk/pull/14739&lt;/a&gt;&lt;br/&gt;
Date: 2023-06-30 16:26:43 +0000</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10200">
                    <name>Backport</name>
                                            <outwardlinks description="backported by">
                                        <issuelink>
            <issuekey id="5108755">JDK-8314918</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="5109240">JDK-8315349</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="5115754">JDK-8321019</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10002">
                    <name>Duplicate</name>
                                            <outwardlinks description="duplicates">
                                        <issuelink>
            <issuekey id="5103500">JDK-8310295</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="duplicates">
                                        <issuelink>
            <issuekey id="5103455">JDK-8310261</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10003">
                    <name>Relates</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="5105857">JDK-8312394</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="5106116">JDK-8312620</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="5105826">JDK-8312366</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="5103456">JDK-8310262</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="5105621">JDK-8312182</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="5103930">JDK-8310687</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_11700" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_10600" key="com.oracle.jira.javabugsystem-jira-plugin:jbs-fixedBackportedCustomfield">
                        <customfieldname>Fixed</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_11100" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i31y1v:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_11004" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_10006" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Resolved In Build</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="17335"><![CDATA[b07]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_10008" key="com.oracle.jira.jira-subcomponent-plugin:oracle-subComponentField">
                        <customfieldname>Subcomponent</customfieldname>
                        <customfieldvalues>
                             <customfieldvalue key="192"><![CDATA[runtime]]></customfieldvalue> 
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_10601" key="com.oracle.jira.javabugsystem-jira-plugin:jbs-targetBackportedCustomfield">
                        <customfieldname>Targeted</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>