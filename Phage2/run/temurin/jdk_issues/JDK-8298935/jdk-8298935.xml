<!-- 
RSS generated by JIRA (9.12.27#9120027-sha1:edc4490121e366e9e7bd2213d532dbe7e028fc5d) at Tue Sep 30 14:59:24 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>Java Bug System</title>
    <link>https://bugs.openjdk.org</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-us</language>    <build-info>
        <version>9.12.27</version>
        <build-number>9120027</build-number>
        <build-date>02-09-2025</build-date>
    </build-info>


<item>
            <title>[JDK-8298935] fix independence bug in create_pack logic in SuperWord::find_adjacent_refs</title>
                <link>https://bugs.openjdk.org/browse/JDK-8298935</link>
                <project id="10100" key="JDK">JDK</project>
                    <description>Please change the generic bug title to something more descriptive once the root cause is known. &lt;br/&gt;
&lt;br/&gt;
The attached Java Fuzzer test results in a wrong execution with C2 compared to a run with the interpreter/C1:&lt;br/&gt;
&lt;br/&gt;
To reproduce:&lt;br/&gt;
$ java -Xint Test.java &amp;gt; interpreter.log&lt;br/&gt;
$ java -XX:-TieredCompilation -Xcomp -XX:CompileOnly=Test Test.java &amp;gt; c2.log&lt;br/&gt;
$ diff interpreter.log c2.log&lt;br/&gt;
&lt;br/&gt;
$ java -Xint Reduced.java &amp;gt; interpreter.log&lt;br/&gt;
$ java -XX:-TieredCompilation -Xcomp -XX:CompileOnly=Reduced Reduced.java &amp;gt; c2.log&lt;br/&gt;
$ diff interpreter.log c2.log&lt;br/&gt;
&lt;br/&gt;
Output of Test.java diff:&lt;br/&gt;
0a1&lt;br/&gt;
&amp;gt; CompileCommand: compileonly Test.* bool compileonly = true&lt;br/&gt;
10c11&lt;br/&gt;
&amp;lt; vMeth_check_sum: 2660033801921391608&lt;br/&gt;
---&lt;br/&gt;
&amp;gt; vMeth_check_sum: 2660033801921192200&lt;br/&gt;
21c22&lt;br/&gt;
&amp;lt; vMeth_check_sum: 5320067603842783216&lt;br/&gt;
---&lt;br/&gt;
&amp;gt; vMeth_check_sum: 5320067603842332488&lt;br/&gt;
32c33&lt;br/&gt;
&amp;lt; vMeth_check_sum: 7980101405764174824&lt;br/&gt;
---&lt;br/&gt;
&amp;gt; vMeth_check_sum: 7980101405763472776&lt;br/&gt;
43c44&lt;br/&gt;
&amp;lt; vMeth_check_sum: -7806608866023985184&lt;br/&gt;
---&lt;br/&gt;
&amp;gt; vMeth_check_sum: -7806608866024938552&lt;br/&gt;
54c55&lt;br/&gt;
&amp;lt; vMeth_check_sum: -5146575064102593576&lt;br/&gt;
---&lt;br/&gt;
&amp;gt; vMeth_check_sum: -5146575064103798264&lt;br/&gt;
65c66&lt;br/&gt;
&amp;lt; vMeth_check_sum: -2486541262181201968&lt;br/&gt;
---&lt;br/&gt;
&amp;gt; vMeth_check_sum: -2486541262182657976&lt;br/&gt;
76c77&lt;br/&gt;
&amp;lt; vMeth_check_sum: 173492539740189640&lt;br/&gt;
---&lt;br/&gt;
&amp;gt; vMeth_check_sum: 173492539738482312&lt;br/&gt;
87c88&lt;br/&gt;
&amp;lt; vMeth_check_sum: 2833526341661581248&lt;br/&gt;
---&lt;br/&gt;
&amp;gt; vMeth_check_sum: 2833526341659622600&lt;br/&gt;
98c99&lt;br/&gt;
&amp;lt; vMeth_check_sum: 5493560143582972856&lt;br/&gt;
---&lt;br/&gt;
&amp;gt; vMeth_check_sum: 5493560143580771093&lt;br/&gt;
109c110&lt;br/&gt;
&amp;lt; vMeth_check_sum: 8153593945504364464&lt;br/&gt;
---&lt;br/&gt;
&amp;gt; vMeth_check_sum: 8153593945501923741&lt;br/&gt;
</description>
                <environment></environment>
        <key id="5089917">JDK-8298935</key>
            <summary>fix independence bug in create_pack logic in SuperWord::find_adjacent_refs</summary>
                <type id="1" iconUrl="https://bugs.openjdk.org/secure/viewavatar?size=xsmall&amp;avatarId=14703&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://bugs.openjdk.org/images/jbsImages/p3.png">P3</priority>
                        <status id="5" iconUrl="https://bugs.openjdk.org/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="success"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="epeter">Emanuel Peter</assignee>
                                    <reporter username="chagedorn">Christian Hagedorn</reporter>
                        <labels>
                            <label>atr</label>
                            <label>c2</label>
                            <label>c2-superword</label>
                            <label>javafuzzer</label>
                            <label>oracle-triage-21</label>
                    </labels>
                <created>Fri, 16 Dec 2022 03:04:40 -0800</created>
                <updated>Wed, 4 Jun 2025 03:09:26 -0700</updated>
                            <resolved>Wed, 15 Mar 2023 07:05:32 -0700</resolved>
                                    <version>8</version>
                    <version>11</version>
                    <version>17</version>
                    <version>18</version>
                    <version>19</version>
                    <version>20</version>
                    <version>21</version>
                                    <fixVersion>21</fixVersion>
                                    <component>hotspot</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="14567115" author="dukebot" created="Wed, 15 Mar 2023 07:05:31 -0700"  >Changeset: 01e69205&lt;br/&gt;
Author:    Emanuel Peter &amp;lt;&lt;a href=&apos;mailto:epeter@openjdk.org&apos;&gt;epeter@openjdk.org&lt;/a&gt;&amp;gt;&lt;br/&gt;
Date:      2023-03-15 14:02:45 +0000&lt;br/&gt;
URL:       &lt;a href=&quot;https://git.openjdk.org/jdk/commit/01e6920581407bc3bd69db495fc694629ef01262&quot;&gt;https://git.openjdk.org/jdk/commit/01e6920581407bc3bd69db495fc694629ef01262&lt;/a&gt;&lt;br/&gt;
</comment>
                            <comment id="14558748" author="roboduke" created="Thu, 9 Feb 2023 00:44:29 -0800"  >A pull request was submitted for review.&lt;br/&gt;
URL: &lt;a href=&quot;https://git.openjdk.org/jdk/pull/12350&quot;&gt;https://git.openjdk.org/jdk/pull/12350&lt;/a&gt;&lt;br/&gt;
Date: 2023-01-31 18:26:52 +0000</comment>
                            <comment id="14554665" author="JIRAUSER19821" created="Thu, 26 Jan 2023 04:19:53 -0800"  >I summarize what I have found so far.&lt;br/&gt;
&lt;br/&gt;
As far as I understand, at the time when we do SuperWord::schedule, there should be no cyclic dependencies between the packs (except for reduction packs, they have self-cycles).&lt;br/&gt;
&lt;br/&gt;
I added some verification code between SuperWord::filter_packs and SuperWord::schedule, that builds a pack-dependency-graph, and detects cycles (see verification_patch.diff). It seems to pass for the tests we have from tier1-3, but triggers for Reduced2.java.&lt;br/&gt;
&lt;br/&gt;
./java -XX:-TieredCompilation -Xcomp -XX:CompileOnly=Reduced2::test -XX:CompileCommand=printcompilation,Reduced2::* -XX:+PrintInlining -XX:+TraceSuperWord -XX:LoopMaxUnroll=5 Reduced2.java&lt;br/&gt;
&lt;br/&gt;
(LoopMaxUnroll=5 is not necessary, but it makes the example a bitter smaller)&lt;br/&gt;
(see also Reduced2.0_before.png and Reduced2.1_after.png to see the graph before and after SuperWord)&lt;br/&gt;
&lt;br/&gt;
When one turns on -XX:+TraceSuperWord, one can see how the packset develops.&lt;br/&gt;
&lt;br/&gt;
This is the function that creates issues:&lt;br/&gt;
&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;static void test() {&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;for (int i = 4; i &amp;lt; 100; i++) {&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;int v = iArr[i];&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;iArr[i + 2] = v; // write 2 ahead (relative offset)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;fArr[i] = v; // seems required, but leads to wrong result&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}&lt;br/&gt;
&lt;br/&gt;
Basically, we take values from the int-array, and write them back with a relative offset of 2, and also write them to the float-array. With an unrolling factor of 4, we see that we read the values from the int-array of positions [i, i+1, i+2, i+3] and write to positions [i+2, i+3, i+4, i+5] in the int-array. But when we sequentially execute the function, we see that when we read position i+2, it has already been overwritten when we read (i) and wrote it into (i+2). So there is a cyclic dependency in the LoadI and StoreI pack. However, we don&amp;#39;t detect it because the relative offset is 2 (also works for relative offset of 3, and if we let it unroll to 16x, any relative offset from 2..15 works).&lt;br/&gt;
&lt;br/&gt;
Sadly, we don&amp;#39;t seem to pick up on that cyclic dependency. SuperWord::schedule assumes there is no cyclic dependency, and schedules all LoadI before the StoreI, leading to wrong results.&lt;br/&gt;
&lt;br/&gt;
Analysis:&lt;br/&gt;
After SuperWord::find_adjacent_refs we find the pack-pairs for LoadI, StoreI and StoreF.&lt;br/&gt;
During SuperWord::extend_packlist we also get the ConvI2F pack-pairs.&lt;br/&gt;
In SuperWord::combine_packs, we combine the pairs to vectors of length 4 (one per StoreF, StoreI, LoadI, ConvI2F).&lt;br/&gt;
This seems to be a problematic step - before the pair-packs did not have any aliasing issues, as long as we had a relative offset of at least 2, pairs cannot detect that.&lt;br/&gt;
SuperWord::filter_packs does not remove any of the packs.&lt;br/&gt;
&lt;br/&gt;
Modified test 1:&lt;br/&gt;
If I use relative offset 1, then the pair-packs detect that they are dependent on their peer in the pair -&amp;gt; pair is not formed. Should we not do this check when we combine the pairs?&lt;br/&gt;
&lt;br/&gt;
Modified test 2&lt;br/&gt;
If I modify the function, and turn the float-array into a second int-array, then I can see that the StoreI for the first int-array does not generate the necessary 3 pack-pairs, but only 2 (the middle one is missing). That way, it is not made into a length 4 vector, and filtered out. That leads to everything else being filtered out - vectorisation fails as it should.&lt;br/&gt;
&lt;br/&gt;
Current working hypothesis:&lt;br/&gt;
We need to check independence of the packs we combine in SuperWord::combine_packs. I have a verification-patch that checks this, and am now running testing to see if it passes on all other tests.</comment>
                            <comment id="14554095" author="JIRAUSER19821" created="Tue, 24 Jan 2023 09:10:12 -0800"  >It looks like the pack algo created cyclic dependencies.&lt;br/&gt;
I am working on a verifier to catch cycles.</comment>
                            <comment id="14553455" author="JIRAUSER19821" created="Mon, 23 Jan 2023 04:01:36 -0800"  >I reduced it a bit further down, and restricted comilation:&lt;br/&gt;
&lt;br/&gt;
./java -Xint Reduced2.java&lt;br/&gt;
&amp;quot;sum 0&amp;quot;&lt;br/&gt;
./java -XX:-TieredCompilation -Xcomp -XX:CompileOnly=Reduced2::test -XX:CompileCommand=printcompilation,Reduced2::* -XX:+PrintInlining Reduced2.java&lt;br/&gt;
&amp;quot;sum 60&amp;quot;</comment>
                            <comment id="14553435" author="JIRAUSER19821" created="Mon, 23 Jan 2023 02:47:59 -0800"  >Thanks [~chagedorn] for reducing the test!&lt;br/&gt;
&lt;br/&gt;
./java -Xint Reduced.java &amp;gt; interpreter.log&lt;br/&gt;
./java -XX:-TieredCompilation -Xcomp -XX:CompileOnly=Reduced Reduced.java &amp;gt; c2.log&lt;br/&gt;
diff interpreter.log c2.log&lt;br/&gt;
&lt;br/&gt;
1c1,2&lt;br/&gt;
&amp;lt; x -32958&lt;br/&gt;
---&lt;br/&gt;
&amp;gt; CompileCommand: compileonly Reduced.* bool compileonly = true&lt;br/&gt;
&amp;gt; x -37468</comment>
                            <comment id="14546046" author="chagedorn" created="Fri, 16 Dec 2022 03:06:24 -0800"  >ILW = Wrong execution of C2 compiled code, single Java Fuzzer testcase, use -XX:-UseSuperWord or disable compilation of affected method = HLM = P3</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10000">
                    <name>Blocks</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="5095778">JDK-8303827</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10003">
                    <name>Relates</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="5160549">JDK-8358581</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="5096046">JDK-8304042</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="5106061">JDK-8312570</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="5094895">JDK-8303113</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="5095320">JDK-8303466</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="5097265">JDK-8305055</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="102100" name="FuzzerUtils.java" size="13240" author="chagedorn" created="Fri, 16 Dec 2022 03:04:37 -0800"/>
                            <attachment id="102376" name="Reduced.java" size="913" author="chagedorn" created="Mon, 23 Jan 2023 02:07:21 -0800"/>
                            <attachment id="102420" name="Reduced2.0_before.png" size="117718" author="epeter" created="Thu, 26 Jan 2023 03:55:52 -0800"/>
                            <attachment id="102419" name="Reduced2.1_after.png" size="60285" author="epeter" created="Thu, 26 Jan 2023 03:55:53 -0800"/>
                            <attachment id="102423" name="Reduced2.java" size="754" author="epeter" created="Thu, 26 Jan 2023 04:08:12 -0800"/>
                            <attachment id="102101" name="Test.java" size="8136" author="chagedorn" created="Fri, 16 Dec 2022 03:04:35 -0800"/>
                            <attachment id="103063" name="generator.py" size="30884" author="epeter" created="Mon, 20 Mar 2023 07:17:30 -0700"/>
                            <attachment id="102421" name="verification_patch.diff" size="5848" author="epeter" created="Thu, 26 Jan 2023 03:56:49 -0800"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_11700" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_10600" key="com.oracle.jira.javabugsystem-jira-plugin:jbs-fixedBackportedCustomfield">
                        <customfieldname>Fixed</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_11100" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2znpf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_11004" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_10006" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Resolved In Build</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="17407"><![CDATA[b14]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_10008" key="com.oracle.jira.jira-subcomponent-plugin:oracle-subComponentField">
                        <customfieldname>Subcomponent</customfieldname>
                        <customfieldvalues>
                             <customfieldvalue key="208"><![CDATA[compiler]]></customfieldvalue> 
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_10601" key="com.oracle.jira.javabugsystem-jira-plugin:jbs-targetBackportedCustomfield">
                        <customfieldname>Targeted</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>