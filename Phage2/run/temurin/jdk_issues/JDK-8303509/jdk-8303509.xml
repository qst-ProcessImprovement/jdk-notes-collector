<!-- 
RSS generated by JIRA (9.12.27#9120027-sha1:edc4490121e366e9e7bd2213d532dbe7e028fc5d) at Tue Sep 30 17:23:23 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>Java Bug System</title>
    <link>https://bugs.openjdk.org</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-us</language>    <build-info>
        <version>9.12.27</version>
        <build-number>9120027</build-number>
        <build-date>02-09-2025</build-date>
    </build-info>


<item>
            <title>[JDK-8303509]  Socket setTrafficClass does not work for IPv4 connections when IPv6 enabled</title>
                <link>https://bugs.openjdk.org/browse/JDK-8303509</link>
                <project id="10100" key="JDK">JDK</project>
                    <description>ADDITIONAL SYSTEM INFORMATION :&lt;br/&gt;
Java:&lt;br/&gt;
&lt;br/&gt;
/usr/lib/jvm/jdk-17-oracle-x64/bin/java -version&lt;br/&gt;
java version &amp;quot;17.0.6&amp;quot; 2023-01-17 LTS&lt;br/&gt;
Java(TM) SE Runtime Environment (build 17.0.6+9-LTS-190)&lt;br/&gt;
Java HotSpot(TM) 64-Bit Server VM (build 17.0.6+9-LTS-190, mixed mode, sharing)&lt;br/&gt;
&lt;br/&gt;
uname -a&lt;br/&gt;
Linux xxx 3.10.0-327.28.3.el7.x86_64 #1 SMP Thu Aug 18 19:05:49 UTC 2016 x86_64 x86_64 x86_64 GNU/Linux&lt;br/&gt;
&lt;br/&gt;
&lt;br/&gt;
A DESCRIPTION OF THE PROBLEM :&lt;br/&gt;
Set traffc class value to 10 and get 10 by `getTrafficClass` method, but ip package show 0 in jdk17. &lt;br/&gt;
&lt;br/&gt;
But it works with jdk11.&lt;br/&gt;
&lt;br/&gt;
STEPS TO FOLLOW TO REPRODUCE THE PROBLEM :&lt;br/&gt;
1. start server side by nc -l 8001&lt;br/&gt;
2. Capture the traffic by tcpdump :  tcpdump -vvv -nnX -c1000  &lt;br/&gt;
3. Run client and sent a package with traffic class 10 to server&lt;br/&gt;
4. You can see ip package tos value is 0x0&lt;br/&gt;
&lt;br/&gt;
EXPECTED VERSUS ACTUAL BEHAVIOR :&lt;br/&gt;
EXPECTED -&lt;br/&gt;
ip tos value is 10&lt;br/&gt;
ACTUAL -&lt;br/&gt;
14:22:37.643746 IP (tos 0x0, ttl 61, id 4843, offset 0, flags [DF], proto TCP (6), length 52)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;10.203.24.118.48400 &amp;gt; 10.203.26.199.8001: Flags [S], cksum 0x99bd (correct), seq 1194522346, win 29200, options [mss 1460,nop,nop,sackOK,nop,wscale 9], length 0&lt;br/&gt;
	0x0000:  4500 0034 12eb 4000 3d06 e206 0acb 1876  E..4..@.=......v&lt;br/&gt;
	0x0010:  0acb 1ac7 bd10 1f41 4732 f6ea 0000 0000  .......AG2......&lt;br/&gt;
	0x0020:  8002 7210 99bd 0000 0204 05b4 0101 0402  ..r.............&lt;br/&gt;
	0x0030:  0103 0309                                ....&lt;br/&gt;
14:22:37.643789 IP (tos 0x0, ttl 61, id 4844, offset 0, flags [DF], proto TCP (6), length 40)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;10.203.24.118.48400 &amp;gt; 10.203.26.199.8001: Flags [.], cksum 0x71ab (correct), seq 1194522347, ack 584628180, win 58, length 0&lt;br/&gt;
	0x0000:  4500 0028 12ec 4000 3d06 e211 0acb 1876  E..(..@.=......v&lt;br/&gt;
	0x0010:  0acb 1ac7 bd10 1f41 4732 f6eb 22d8 b7d4  .......AG2..&amp;quot;...&lt;br/&gt;
	0x0020:  5010 003a 71ab 0000 0000 0000 0000       P..:q.........&lt;br/&gt;
14:22:37.645627 IP (tos 0x0, ttl 61, id 4845, offset 0, flags [DF], proto TCP (6), length 41)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;10.203.24.118.48400 &amp;gt; 10.203.26.199.8001: Flags [P.], cksum 0x70a2 (correct), seq 0:1, ack 1, win 58, length 1&lt;br/&gt;
	0x0000:  4500 0029 12ed 4000 3d06 e20f 0acb 1876  E..)..@.=......v&lt;br/&gt;
	0x0010:  0acb 1ac7 bd10 1f41 4732 f6eb 22d8 b7d4  .......AG2..&amp;quot;...&lt;br/&gt;
	0x0020:  5018 003a 70a2 0000 0100 0000 0000       P..:p.........&lt;br/&gt;
14:22:37.646338 IP (tos 0x0, ttl 61, id 4846, offset 0, flags [DF], proto TCP (6), length 40)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;10.203.24.118.48400 &amp;gt; 10.203.26.199.8001: Flags [F.], cksum 0x71a9 (correct), seq 1, ack 1, win 58, length 0&lt;br/&gt;
	0x0000:  4500 0028 12ee 4000 3d06 e20f 0acb 1876  E..(..@.=......v&lt;br/&gt;
	0x0010:  0acb 1ac7 bd10 1f41 4732 f6ec 22d8 b7d4  .......AG2..&amp;quot;...&lt;br/&gt;
	0x0020:  5011 003a 71a9 0000 0000 0000 0000       P..:q.........&lt;br/&gt;
14:22:37.646381 IP (tos 0x0, ttl 61, id 4847, offset 0, flags [DF], proto TCP (6), length 40)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;10.203.24.118.48400 &amp;gt; 10.203.26.199.8001: Flags [.], cksum 0x71a8 (correct), seq 2, ack 2, win 58, length 0&lt;br/&gt;
	0x0000:  4500 0028 12ef 4000 3d06 e20e 0acb 1876  E..(..@.=......v&lt;br/&gt;
	0x0010:  0acb 1ac7 bd10 1f41 4732 f6ed 22d8 b7d5  .......AG2..&amp;quot;...&lt;br/&gt;
	0x0020:  5010 003a 71a8 0000 0000 0000 0000       P..:q.........&lt;br/&gt;
&lt;br/&gt;
---------- BEGIN SOURCE ----------&lt;br/&gt;
&lt;br/&gt;
import java.io.IOException;&lt;br/&gt;
import java.io.OutputStream;&lt;br/&gt;
import java.net.Socket;&lt;br/&gt;
&lt;br/&gt;
public class SetTrafficClassTest {&lt;br/&gt;
&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;public static void main(String[] args) throws IOException {&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;if (args.length != 3) {&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;System.err.println(&amp;quot;Arguments: &amp;lt;host&amp;gt; &amp;lt;port&amp;gt; &amp;lt;ip_tos&amp;gt;&amp;quot;);&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;return;&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}&lt;br/&gt;
&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Socket socket = new Socket(args[0], Integer.parseInt(args[1]));&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;socket.setTcpNoDelay(true);&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;OutputStream os = socket.getOutputStream();&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;byte[] bytes = new byte[] {1};&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;int tc = Integer.parseInt(args[2]);&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;socket.setTrafficClass(tc);&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;os.write(bytes);&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;System.out.println(&amp;quot;Set Traffic class to &amp;quot; + tc + &amp;quot;, got &amp;quot; + socket.getTrafficClass());&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;os.flush();&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;os.close();&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;socket.close();&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}&lt;br/&gt;
&lt;br/&gt;
}&lt;br/&gt;
&lt;br/&gt;
---------- END SOURCE ----------&lt;br/&gt;
&lt;br/&gt;
FREQUENCY : always&lt;br/&gt;
&lt;br/&gt;
&lt;br/&gt;
</description>
                <environment></environment>
        <key id="5095269">JDK-8303509</key>
            <summary> Socket setTrafficClass does not work for IPv4 connections when IPv6 enabled</summary>
                <type id="1" iconUrl="https://bugs.openjdk.org/secure/viewavatar?size=xsmall&amp;avatarId=14703&amp;avatarType=issuetype">Bug</type>
                                            <priority id="5" iconUrl="https://bugs.openjdk.org/images/jbsImages/p5.png">P5</priority>
                        <status id="5" iconUrl="https://bugs.openjdk.org/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="success"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="alanb">Alan Bateman</assignee>
                                    <reporter username="webbuggrp">Webbug Group</reporter>
                        <labels>
                            <label>dcsaw</label>
                            <label>noreg-hard</label>
                            <label>webbug</label>
                    </labels>
                <created>Tue, 28 Feb 2023 22:43:01 -0800</created>
                <updated>Thu, 16 Mar 2023 00:17:17 -0700</updated>
                            <resolved>Thu, 9 Mar 2023 00:15:32 -0800</resolved>
                                    <version>13</version>
                    <version>17</version>
                                    <fixVersion>21</fixVersion>
                                    <component>core-libs</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="14565467" author="dukebot" created="Thu, 9 Mar 2023 00:15:29 -0800"  >Changeset: dd794108&lt;br/&gt;
Author:    Alan Bateman &amp;lt;&lt;a href=&apos;mailto:alanb@openjdk.org&apos;&gt;alanb@openjdk.org&lt;/a&gt;&amp;gt;&lt;br/&gt;
Date:      2023-03-09 08:13:57 +0000&lt;br/&gt;
URL:       &lt;a href=&quot;https://git.openjdk.org/jdk/commit/dd79410824fa57c7fb1ce56c643bb52540f9a206&quot;&gt;https://git.openjdk.org/jdk/commit/dd79410824fa57c7fb1ce56c643bb52540f9a206&lt;/a&gt;&lt;br/&gt;
</comment>
                            <comment id="14564680" author="roboduke" created="Mon, 6 Mar 2023 07:28:36 -0800"  >A pull request was submitted for review.&lt;br/&gt;
URL: &lt;a href=&quot;https://git.openjdk.org/jdk/pull/12852&quot;&gt;https://git.openjdk.org/jdk/pull/12852&lt;/a&gt;&lt;br/&gt;
Date: 2023-03-03 10:36:45 +0000</comment>
                            <comment id="14564532" author="roboduke" created="Sun, 5 Mar 2023 11:23:03 -0800"  >A pull request was submitted for review.&lt;br/&gt;
URL: &lt;a href=&quot;https://git.openjdk.org/jdk/pull/12872&quot;&gt;https://git.openjdk.org/jdk/pull/12872&lt;/a&gt;&lt;br/&gt;
Date: 2023-03-05 09:33:34 +0000</comment>
                            <comment id="14564030" author="alanb" created="Thu, 2 Mar 2023 00:18:52 -0800"  >I&amp;#39;ve changed this issue to make it clearer what it is about. In summary, since JDK 13, Socket.setTrafficClass only sets IPV6_TCLASS on Linux when IPv6 is enabled. On Linux it requires both IPV6_TCLASS and IP_TOS when the socket is not connected, and IP_TOS when the socket is connected to an IPv4 address.&lt;br/&gt;
&lt;br/&gt;
It can be  worked around by using an IPv4 socket, e.g. SocketChannel.open(INET).socket() or running with -Djava.net.preferIPv4Stack=true.&lt;br/&gt;
&lt;br/&gt;
As a general point is is somewhat unusual to see Socket.setTraffiClass actually used as setting IPV6_TCLASS or IP_TOS is more typical on UDP sockets. In StandardSocketOptions, IP_TOS is unspecified for stream-oriented sockets.&lt;br/&gt;
&lt;br/&gt;
In any case, I&amp;#39;ve attached IP_TOS.patch to this issue with an initial patch. The patch adding a new mapping for UNSPEC/IP_TOS to the socket registry so that the socket option can be handled by the net code. This also limits the change to the NIO based SocketImpl.&lt;br/&gt;
</comment>
                            <comment id="14564025" author="alanb" created="Wed, 1 Mar 2023 23:13:50 -0800"  >[~tongwan] This can&amp;#39;t be tested with getTrafficClass, instead it needs a tcpdump or network analyzer to see the network packet.</comment>
                            <comment id="14564020" author="tongwan" created="Wed, 1 Mar 2023 23:01:17 -0800"  >The observations on Oracle Linux:&lt;br/&gt;
JDK 17: Passed, Set Traffic class to 10, got 10&lt;br/&gt;
</comment>
                            <comment id="14563837" author="alanb" created="Wed, 1 Mar 2023 06:38:27 -0800"  >IP_TOS and IPV6_TCLASS is usually not too interesting for stream/TCP sockets. When the underlying socket is IPv6 (the default on most systems), setTrafficClass maps to the IPPROTO_IPV6/IPV6_TCLASS so it might not be effective for IPv4 connections. It would be useful to know if running with -Djava.net.preferIPv4Stack=true can be traced as that should set IPPROTO/IP_TOS.</comment>
                    </comments>
                    <attachments>
                            <attachment id="102893" name="IP_TOS.patch" size="2801" author="alanb" created="Sun, 5 Mar 2023 01:07:07 -0800"/>
                            <attachment id="102868" name="SetTrafficClassTest.java" size="786" author="tongwan" created="Wed, 1 Mar 2023 23:01:39 -0800"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_10000" key="com.atlassian.jira.plugin.system.customfieldtypes:multiselect">
                        <customfieldname>CPU</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="17008"><![CDATA[generic]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_11700" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_10600" key="com.oracle.jira.javabugsystem-jira-plugin:jbs-fixedBackportedCustomfield">
                        <customfieldname>Fixed</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_10005" key="com.atlassian.jira.plugin.system.customfieldtypes:multiselect">
                        <customfieldname>OS</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="17023"><![CDATA[linux]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_11100" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i30kn7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_11004" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_10006" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Resolved In Build</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="17407"><![CDATA[b14]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_10008" key="com.oracle.jira.jira-subcomponent-plugin:oracle-subComponentField">
                        <customfieldname>Subcomponent</customfieldname>
                        <customfieldvalues>
                             <customfieldvalue key="193"><![CDATA[java.net]]></customfieldvalue> 
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_10601" key="com.oracle.jira.javabugsystem-jira-plugin:jbs-targetBackportedCustomfield">
                        <customfieldname>Targeted</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>