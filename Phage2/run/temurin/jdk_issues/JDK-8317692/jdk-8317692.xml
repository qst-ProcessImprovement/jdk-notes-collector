<!-- 
RSS generated by JIRA (9.12.27#9120027-sha1:edc4490121e366e9e7bd2213d532dbe7e028fc5d) at Tue Sep 30 10:31:29 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>Java Bug System</title>
    <link>https://bugs.openjdk.org</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-us</language>    <build-info>
        <version>9.12.27</version>
        <build-number>9120027</build-number>
        <build-date>02-09-2025</build-date>
    </build-info>


<item>
            <title>[JDK-8317692] jcmd GC.heap_dump performance regression after JDK-8292818</title>
                <link>https://bugs.openjdk.org/browse/JDK-8317692</link>
                <project id="10100" key="JDK">JDK</project>
                    <description>&lt;a href=&quot;https://bugs.openjdk.org/browse/JDK-8292818&quot; title=&quot;replace 96-bit representation for field metadata with variable-sized streams&quot; class=&quot;issue-link&quot; data-issue-key=&quot;JDK-8292818&quot;&gt;&lt;strike&gt;JDK-8292818&lt;/strike&gt;&lt;/a&gt; changed how field metadata (e.g. access flags) is accessed to streaming access. That means accessing a field of a InstanceKlass by index has to go through the stream to find the appropriate field.&lt;br/&gt;
&lt;br/&gt;
This causes a performance regression in jcmd GC.heap_dump, which uses FieldStream from reflectionUtils.hpp. This implementation has two flaws in combination with the change from &lt;a href=&quot;https://bugs.openjdk.org/browse/JDK-8292818&quot; title=&quot;replace 96-bit representation for field metadata with variable-sized streams&quot; class=&quot;issue-link&quot; data-issue-key=&quot;JDK-8292818&quot;&gt;&lt;strike&gt;JDK-8292818&lt;/strike&gt;&lt;/a&gt;:&lt;br/&gt;
&lt;br/&gt;
1. It uses field indexes to access data, e.g. _klass-&amp;gt;field_access_flags(_index) to get a field&amp;#39;s access flags.&lt;br/&gt;
2. It traverses the fields in reverse order. The way how the metadata is stored now only allows for efficient forward traversal.&lt;br/&gt;
&lt;br/&gt;
As an example, running the attached Java file and creating a heap dump takes (on my machine):&lt;br/&gt;
- 2-3 seconds on Java 17&lt;br/&gt;
- ~20 seconds on Java 21&lt;br/&gt;
&lt;br/&gt;
FieldStream cannot directly be replaced by the implementations from fieldStreams.hpp because it additionally traverses supertypes.&lt;br/&gt;
&lt;br/&gt;
The proposed fix is to add field streaming with supertype traversal to fieldStreams.hpp. This way, other usages of FIeldStream are unaffected in behavior. The new implementation does foward traversal over the fields but keeps the order in which supertypes visited from FieldStream. This way, the produced heap dump will still conform to the hprof format.&lt;br/&gt;
&lt;br/&gt;
Relevant mailing list discussion: &lt;a href=&quot;https://mail.openjdk.org/pipermail/serviceability-dev/2023-October/051571.html&quot;&gt;https://mail.openjdk.org/pipermail/serviceability-dev/2023-October/051571.html&lt;/a&gt;</description>
                <environment></environment>
        <key id="5111923">JDK-8317692</key>
            <summary>jcmd GC.heap_dump performance regression after JDK-8292818</summary>
                <type id="1" iconUrl="https://bugs.openjdk.org/secure/viewavatar?size=xsmall&amp;avatarId=14703&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://bugs.openjdk.org/images/jbsImages/p4.png">P4</priority>
                        <status id="5" iconUrl="https://bugs.openjdk.org/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="success"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hgreule">Hannes Greule</assignee>
                                    <reporter username="hgreule">Hannes Greule</reporter>
                        <labels>
                            <label>amazon-interest</label>
                            <label>jdk21u-fix-SQE-ok</label>
                            <label>jdk21u-fix-request</label>
                            <label>jdk21u-fix-yes</label>
                            <label>metadata</label>
                            <label>performance</label>
                            <label>regression</label>
                    </labels>
                <created>Fri, 6 Oct 2023 13:38:21 -0700</created>
                <updated>Thu, 26 Oct 2023 00:39:51 -0700</updated>
                            <resolved>Thu, 19 Oct 2023 16:26:10 -0700</resolved>
                                    <version>21</version>
                    <version>22</version>
                                    <fixVersion>22</fixVersion>
                                    <component>hotspot</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="14619752" author="shade" created="Fri, 20 Oct 2023 01:28:57 -0700"  >Okay, now I see the 21u PR, and bots linked it here. And I see your &amp;quot;Fix Request&amp;quot; comment here, good. So the only thing that is missing is putting the jdk21u-fix-request tag back. Then we wait for maintainer approval. When that happens, bots would mark 21u PR as ready for integration.</comment>
                            <comment id="14619751" author="roboduke" created="Fri, 20 Oct 2023 01:28:45 -0700"  >A pull request was submitted for review.&lt;br/&gt;
URL: &lt;a href=&quot;https://git.openjdk.org/jdk21u/pull/274&quot;&gt;https://git.openjdk.org/jdk21u/pull/274&lt;/a&gt;&lt;br/&gt;
Date: 2023-10-20 08:21:41 +0000</comment>
                            <comment id="14619750" author="JIRAUSER20802" created="Fri, 20 Oct 2023 01:26:08 -0700"  >Hi Aleksey, I tried to follow &lt;a href=&quot;https://openjdk.org/projects/jdk-updates/approval.html,&quot;&gt;https://openjdk.org/projects/jdk-updates/approval.html,&lt;/a&gt; but maybe I misunderstood things there. I now created the PR in the jdk21u repo. Please let me know if something is missing.</comment>
                            <comment id="14619745" author="JIRAUSER20802" created="Fri, 20 Oct 2023 01:12:00 -0700"  >Fix Request&lt;br/&gt;
This fix heavily improves the performance of heap dump functionality via jcmd. Even for below 1GB heaps, I encountered situations where a heap dump took multiple minutes due to the regression. With this change, the duration is now back to a few seconds.&lt;br/&gt;
The change only affects the heapDumper functionality and therefore I expect it to have a low impact. It also adds tests that ensure all instance fields are present in heap dumps. &lt;br/&gt;
The patch applies cleanly.</comment>
                            <comment id="14619741" author="shade" created="Fri, 20 Oct 2023 01:04:40 -0700"  >Hannes, we need to follow the backporting process to get it to 21u; it is not enough to just put the jdk21u-fix-request label, unfortunately. It would probably be enough to go to the changeset (&lt;a href=&quot;https://git.openjdk.org/jdk/commit/8f5f44070a7c6dbbbd1005f9d0af5ab7c35179df),&quot;&gt;https://git.openjdk.org/jdk/commit/8f5f44070a7c6dbbbd1005f9d0af5ab7c35179df),&lt;/a&gt; say `/backport jdk21u` in comments there, and then follow bots instructions. &lt;br/&gt;
&lt;br/&gt;
I will remove jdk21u-fix-request meanwhile as to not confuse the jdk21u maintainers.</comment>
                            <comment id="14619677" author="dukebot" created="Thu, 19 Oct 2023 16:26:09 -0700"  >Changeset: 8f5f4407&lt;br/&gt;
Author:    Hannes Greule &amp;lt;&lt;a href=&apos;mailto:hgreule@openjdk.org&apos;&gt;hgreule@openjdk.org&lt;/a&gt;&amp;gt;&lt;br/&gt;
Committer: David Holmes &amp;lt;&lt;a href=&apos;mailto:dholmes@openjdk.org&apos;&gt;dholmes@openjdk.org&lt;/a&gt;&amp;gt;&lt;br/&gt;
Date:      2023-10-19 23:24:28 +0000&lt;br/&gt;
URL:       &lt;a href=&quot;https://git.openjdk.org/jdk/commit/8f5f44070a7c6dbbbd1005f9d0af5ab7c35179df&quot;&gt;https://git.openjdk.org/jdk/commit/8f5f44070a7c6dbbbd1005f9d0af5ab7c35179df&lt;/a&gt;&lt;br/&gt;
</comment>
                            <comment id="14616554" author="roboduke" created="Fri, 6 Oct 2023 14:08:33 -0700"  >A pull request was submitted for review.&lt;br/&gt;
URL: &lt;a href=&quot;https://git.openjdk.org/jdk/pull/16083&quot;&gt;https://git.openjdk.org/jdk/pull/16083&lt;/a&gt;&lt;br/&gt;
Date: 2023-10-06 20:56:13 +0000</comment>
                            <comment id="14616553" author="dcubed" created="Fri, 6 Oct 2023 14:06:29 -0700"  >Moved to hotspot/runtime for initial triage.</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10200">
                    <name>Backport</name>
                                            <outwardlinks description="backported by">
                                        <issuelink>
            <issuekey id="5113272">JDK-8318881</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10000">
                    <name>Blocks</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="5112899">JDK-8318563</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10003">
                    <name>Relates</name>
                                                                <inwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="5082129">JDK-8292818</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="5112899">JDK-8318563</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="106736" name="CollectNumbers.java" size="410" author="hgreule" created="Fri, 6 Oct 2023 13:07:35 -0700"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_11700" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_10600" key="com.oracle.jira.javabugsystem-jira-plugin:jbs-fixedBackportedCustomfield">
                        <customfieldname>Fixed</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10003" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Introduced In Build</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="17428"><![CDATA[b15]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_10004" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Introduced In Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="22711">21</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_11100" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i33edv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_11004" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_10006" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Resolved In Build</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="17412"><![CDATA[b21]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_10008" key="com.oracle.jira.jira-subcomponent-plugin:oracle-subComponentField">
                        <customfieldname>Subcomponent</customfieldname>
                        <customfieldvalues>
                             <customfieldvalue key="192"><![CDATA[runtime]]></customfieldvalue> 
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_10601" key="com.oracle.jira.javabugsystem-jira-plugin:jbs-targetBackportedCustomfield">
                        <customfieldname>Targeted</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>