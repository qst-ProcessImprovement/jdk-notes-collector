<!-- 
RSS generated by JIRA (9.12.27#9120027-sha1:edc4490121e366e9e7bd2213d532dbe7e028fc5d) at Tue Sep 30 10:19:53 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>Java Bug System</title>
    <link>https://bugs.openjdk.org</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-us</language>    <build-info>
        <version>9.12.27</version>
        <build-number>9120027</build-number>
        <build-date>02-09-2025</build-date>
    </build-info>


<item>
            <title>[JDK-8316130] Incorrect control in LibraryCallKit::inline_native_notify_jvmti_funcs</title>
                <link>https://bugs.openjdk.org/browse/JDK-8316130</link>
                <project id="10100" key="JDK">JDK</project>
                    <description>Running into the following assert while testing some changes&lt;br/&gt;
&lt;br/&gt;
#  Internal Error (/home/albatem/ws/jdk/open/src/hotspot/share/opto/loopnode.cpp:5523), pid=2082704, tid=2082731&lt;br/&gt;
#  assert(!in-&amp;gt;is_CFG()) failed: CFG Node with no controlling input?&lt;br/&gt;
&lt;br/&gt;
Current CompileTask:&lt;br/&gt;
C2:   1878 2115       4       java.lang.VirtualThread$VThreadContinuation$1::run (12 bytes)&lt;br/&gt;
&lt;br/&gt;
Stack: [0x00007fde6d5f1000,0x00007fde6d6f1000],  sp=0x00007fde6d6ebd30,  free space=1003k&lt;br/&gt;
Native frames: (J=compiled Java code, j=interpreted, Vv=VM code, C=native code)&lt;br/&gt;
V  [libjvm.so+0x12970c6]  PhaseIdealLoop::build_loop_early(VectorSet&amp;amp;, Node_List&amp;amp;, Node_Stack&amp;amp;)+0x766  (loopnode.cpp:5523)&lt;br/&gt;
V  [libjvm.so+0x12a2d10]  PhaseIdealLoop::build_and_optimize()+0x5b0  (loopnode.cpp:4446)&lt;br/&gt;
V  [libjvm.so+0x9f0209]  PhaseIdealLoop::optimize(PhaseIterGVN&amp;amp;, LoopOptsMode)+0x3b9  (loopnode.hpp:1110)&lt;br/&gt;
V  [libjvm.so+0x9eb1c0]  Compile::Optimize()+0x820  (compile.cpp:2307)&lt;br/&gt;
V  [libjvm.so+0x9eefd0]  Compile::Compile(ciEnv*, ciMethod*, int, Options, DirectiveSet*)+0x1bb0  (compile.cpp:854)&lt;br/&gt;
V  [libjvm.so+0x849feb]  C2Compiler::compile_method(ciEnv*, ciMethod*, int, bool, DirectiveSet*)+0x13b  (c2compiler.cpp:119)&lt;br/&gt;
V  [libjvm.so+0x9faf40]  CompileBroker::invoke_compiler_on_method(CompileTask*)+0x980  (compileBroker.cpp:2285)&lt;br/&gt;
V  [libjvm.so+0x9fbd78]  CompileBroker::compiler_thread_loop()+0x5f8  (compileBroker.cpp:1946)&lt;br/&gt;
V  [libjvm.so+0xeb784c]  JavaThread::thread_main_inner()+0xcc  (javaThread.cpp:720)&lt;br/&gt;
V  [libjvm.so+0x17a2fea]  Thread::call_run()+0xba  (thread.cpp:220)&lt;br/&gt;
V  [libjvm.so+0x14a1bda]  thread_native_entry(Thread*)+0x12a  (os_linux.cpp:785)&lt;br/&gt;
&lt;br/&gt;
The issue is duplicated by editing src/java.base/share/classes/java/lang/VirtualThread.java and remove @ChangesCurrentThread from the run(Runnable) method. This annotation is not needed on this method as it doesn&amp;#39;t change the current thread.&lt;br/&gt;
&lt;br/&gt;
With that change, run Skynet like this:&lt;br/&gt;
&lt;br/&gt;
cd test/jdk/java/lang/Thread/virtual/stress&lt;br/&gt;
java -XX:NativeMemoryTracking=summary -XX:FlightRecorderOptions=preserve-repository=false -XX:StartFlightRecording=dumponexit=true,settings=profile Skynet.java 100&lt;br/&gt;
&lt;br/&gt;
The assert goes away if the method is changed to have DontInline so this is something to do with the inlining of run(Runnable) into its caller.&lt;br/&gt;
&lt;br/&gt;
</description>
                <environment></environment>
        <key id="5110141">JDK-8316130</key>
            <summary>Incorrect control in LibraryCallKit::inline_native_notify_jvmti_funcs</summary>
                <type id="1" iconUrl="https://bugs.openjdk.org/secure/viewavatar?size=xsmall&amp;avatarId=14703&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://bugs.openjdk.org/images/jbsImages/p3.png">P3</priority>
                        <status id="5" iconUrl="https://bugs.openjdk.org/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="success"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="thartmann">Tobias Hartmann</assignee>
                                    <reporter username="alanb">Alan Bateman</reporter>
                        <labels>
                            <label>amazon-interest</label>
                            <label>c2</label>
                            <label>c2-intrinsic</label>
                            <label>jdk21u-fix-SQE-ok-next</label>
                            <label>jdk21u-fix-request</label>
                            <label>jdk21u-fix-yes</label>
                            <label>loom</label>
                            <label>noreg-hard</label>
                            <label>oracle-triage-17</label>
                            <label>oracle-triage-22</label>
                            <label>regression</label>
                    </labels>
                <created>Tue, 12 Sep 2023 08:48:50 -0700</created>
                <updated>Mon, 11 Dec 2023 11:55:59 -0800</updated>
                            <resolved>Fri, 22 Sep 2023 01:33:08 -0700</resolved>
                                    <version>21</version>
                    <version>22</version>
                                    <fixVersion>22</fixVersion>
                                    <component>hotspot</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="14616533" author="roboduke" created="Fri, 6 Oct 2023 12:03:27 -0700"  >A pull request was submitted for review.&lt;br/&gt;
URL: &lt;a href=&quot;https://git.openjdk.org/jdk21u/pull/232&quot;&gt;https://git.openjdk.org/jdk21u/pull/232&lt;/a&gt;&lt;br/&gt;
Date: 2023-10-06 18:57:35 +0000</comment>
                            <comment id="14616532" author="roboduke" created="Fri, 6 Oct 2023 12:03:07 -0700"  >[jdk21u-fix-request] Approval Request from Aleksey Shipil&amp;#xEB;v&lt;br/&gt;
Fixes C2 bug with Virtual Threads and JVMTI. Applies cleanly.</comment>
                            <comment id="14613111" author="dukebot" created="Fri, 22 Sep 2023 01:33:07 -0700"  >Changeset: 4b654839&lt;br/&gt;
Author:    Tobias Hartmann &amp;lt;&lt;a href=&apos;mailto:thartmann@openjdk.org&apos;&gt;thartmann@openjdk.org&lt;/a&gt;&amp;gt;&lt;br/&gt;
Date:      2023-09-22 08:30:49 +0000&lt;br/&gt;
URL:       &lt;a href=&quot;https://git.openjdk.org/jdk/commit/4b65483921ddadc9dd6c6e6c59b541673e3d2d88&quot;&gt;https://git.openjdk.org/jdk/commit/4b65483921ddadc9dd6c6e6c59b541673e3d2d88&lt;/a&gt;&lt;br/&gt;
</comment>
                            <comment id="14610861" author="roboduke" created="Wed, 13 Sep 2023 04:56:14 -0700"  >A pull request was submitted for review.&lt;br/&gt;
URL: &lt;a href=&quot;https://git.openjdk.org/jdk/pull/15713&quot;&gt;https://git.openjdk.org/jdk/pull/15713&lt;/a&gt;&lt;br/&gt;
Date: 2023-09-13 11:50:03 +0000</comment>
                            <comment id="14610857" author="thartmann" created="Wed, 13 Sep 2023 04:43:46 -0700"  >The problem is an incorrect control in LibraryCallKit::inline_native_notify_jvmti_funcs introduced by &lt;a href=&quot;https://bugs.openjdk.org/browse/JDK-8304303&quot; title=&quot;implement VirtualThread class notifyJvmti methods as C2 intrinsics&quot; class=&quot;issue-link&quot; data-issue-key=&quot;JDK-8304303&quot;&gt;&lt;strike&gt;JDK-8304303&lt;/strike&gt;&lt;/a&gt;. Workaround: -XX:DisableIntrinsic=_notifyJvmtiVThreadEnd&lt;br/&gt;
&lt;br/&gt;
ILW = Assert in C2 due to incorrect control, reproducible with single virtual threads test + JFR + change to libraries, -XX:DisableIntrinsic=_notifyJvmtiVThreadEnd = HLM = P3</comment>
                            <comment id="14610777" author="thartmann" created="Wed, 13 Sep 2023 00:46:25 -0700"  >I can reproduce this. Removing @ChangesCurrentThread from VirtualThread::run allows inlining into VirtualThread$VThreadContinuation$1::run and enabling JFR is required because the run method calls some JFR specific methods. Unfortunately, replay compilation does not work because JFR can&amp;#39;t be enabled with it.&lt;br/&gt;
&lt;br/&gt;
java -XX:FlightRecorderOptions=preserve-repository=false -XX:StartFlightRecording=dumponexit=false,settings=profile -XX:CompileCommand=compileonly,java.lang.VirtualThread\$VThreadContinuation\$1::run Skynet.java 100&lt;br/&gt;
&lt;br/&gt;
0x00007ffff6f34dd4 in PhaseIdealLoop::build_loop_early (this=this@entry=0x7fffd4449390, visited=..., worklist=..., nstack=...) at /oracle/jdk/open/src/hotspot/share/opto/loopnode.cpp:5528&lt;br/&gt;
5528	          assert( !in-&amp;gt;is_CFG(), &amp;quot;CFG Node with no controlling input?&amp;quot; );&lt;br/&gt;
(gdb) p in-&amp;gt;dump(3)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;385  ConI  === 0  [[ 3025 3771 3022 3242 4329 3020 3766 3017 972 4328 4322 3015 3762 3012 1019 4326 3010 3758 3006 4325 3004 3752 4165 3002 3117 3118 3119 185 4324 4023 4552 2520 4551 410 187 182 2774 2879 2098 1961 681 2738 2738 4127 3135 543 3136 544 3137 545 680 679 2124 678 1944 3504 2729 1421 1274 676 677 3681 3492 2699 4611 1253 1718 188 3647 1478 667 3461 666 3460 665 3459 3443 3442 3441 420 183 436 179 2647 1857 642 2615 2615 4066 641 640 184 639 1840 3399 2606 1171 637 2914 638 3387 2576 4571 1150 3241 3356 3355 3354 3338 3337 3336 3335 3334 929 4442 3333 466 4809 609 1761 607 607 608 606 606 605 605 604 580 178 2322 178 178 602 602 602 601 601 601 600 600 600 3305 599 599 599 3304 598 598 598 3168 3302 177 177 177 597 597 597 555 554 951 4944 2352 596 596 3181 596 595 595 595 1361 1361 1361 2046 594 594 1643 594 593 556 2394 582 557 558 592 2477 3905 583 591 591 2034 2034 2034 2361 2361 590 590 559 190 190 1660 589 589 588 588 3230 587 587 1728 1728 1346 1346 586 1038 585 585 586 584 426 ]]  #int:1&lt;br/&gt;
&amp;nbsp;1664  Bool  === _ 2378  [[ 972 ]] [ne] !jvms: VirtualThread::run @ bci:243 (line 325) VirtualThread$VThreadContinuation$1::run @ bci:8 (line 190)&lt;br/&gt;
&amp;nbsp;1663  IfFalse  === 2377  [[ 971 ]] #0 !jvms: VirtualThread::run @ bci:216 (line 317) VirtualThread$VThreadContinuation$1::run @ bci:8 (line 190)&lt;br/&gt;
&amp;nbsp;1662  CatchProj  === 2257  [[ 971 ]] #&lt;a href=&apos;mailto:0@bci&apos;&gt;0@bci&lt;/a&gt; -1  !jvms: VirtualThread::run @ bci:239 (line 320) VirtualThread$VThreadContinuation$1::run @ bci:8 (line 190)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;972  Opaque4  === _ 1664 385  [[ 562 ]]  !jvms: VirtualThread::run @ bci:243 (line 325) VirtualThread$VThreadContinuation$1::run @ bci:8 (line 190)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;971  Region  === 971 1662 1663  [[ 971 562 2227 3018 2232 3016 4792 ]]  !jvms: VirtualThread::run @ bci:242 (line 325) VirtualThread$VThreadContinuation$1::run @ bci:8 (line 190)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;562  If  === 971 972  [[ 239 2231 ]] P=0,999999, C=-1,000000 !jvms: VirtualThread::run @ bci:243 (line 325) VirtualThread$VThreadContinuation$1::run @ bci:8 (line 190)&lt;br/&gt;
&amp;nbsp;2231  IfTrue  === 562  [[ 1544 ]] #1 !jvms: VirtualThread::run @ bci:243 (line 325) VirtualThread$VThreadContinuation$1::run @ bci:8 (line 190)&lt;br/&gt;
&lt;br/&gt;
(gdb) p has_node(in-&amp;gt;_in[0])&lt;br/&gt;
$7 = true&lt;br/&gt;
&lt;br/&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10200">
                    <name>Backport</name>
                                            <outwardlinks description="backported by">
                                        <issuelink>
            <issuekey id="5112030">JDK-8317787</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10003">
                    <name>Relates</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="5096381">JDK-8304303</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_11700" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_10600" key="com.oracle.jira.javabugsystem-jira-plugin:jbs-fixedBackportedCustomfield">
                        <customfieldname>Fixed</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_11100" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i333eb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_11004" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_10006" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Resolved In Build</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="17417"><![CDATA[b17]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_10008" key="com.oracle.jira.jira-subcomponent-plugin:oracle-subComponentField">
                        <customfieldname>Subcomponent</customfieldname>
                        <customfieldvalues>
                             <customfieldvalue key="208"><![CDATA[compiler]]></customfieldvalue> 
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_10601" key="com.oracle.jira.javabugsystem-jira-plugin:jbs-targetBackportedCustomfield">
                        <customfieldname>Targeted</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>