<!-- 
RSS generated by JIRA (9.12.27#9120027-sha1:edc4490121e366e9e7bd2213d532dbe7e028fc5d) at Tue Sep 30 17:39:52 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>Java Bug System</title>
    <link>https://bugs.openjdk.org</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-us</language>    <build-info>
        <version>9.12.27</version>
        <build-number>9120027</build-number>
        <build-date>02-09-2025</build-date>
    </build-info>


<item>
            <title>[JDK-8304042] C2 SuperWord: schedule must remove packs with cyclic dependencies</title>
                <link>https://bugs.openjdk.org/browse/JDK-8304042</link>
                <project id="10100" key="JDK">JDK</project>
                    <description>I have found a Test.java, where we have independency on pair and pack level.&lt;br/&gt;
The nodes in a pack are all mutually independent (none have a path to any other of them).&lt;br/&gt;
But: the packs have cyclic dependencies between them.&lt;br/&gt;
When this is SuperWord-vectorized, it leads to wrong results, operations are reordered that should not be reordered.&lt;br/&gt;
&lt;br/&gt;
Regression Test.java&lt;br/&gt;
./java -XX:CompileCommand=compileonly,Test::test -Xbatch -XX:+TraceSuperWord -XX:+TraceNewVectors Test.java&lt;br/&gt;
&lt;br/&gt;
I found this during the work of &lt;a href=&quot;https://bugs.openjdk.org/browse/JDK-8298935&quot; title=&quot;fix independence bug in create_pack logic in SuperWord::find_adjacent_refs&quot; class=&quot;issue-link&quot; data-issue-key=&quot;JDK-8298935&quot;&gt;&lt;strike&gt;JDK-8298935&lt;/strike&gt;&lt;/a&gt;. The bugs are related, but not the same. &lt;a href=&quot;https://bugs.openjdk.org/browse/JDK-8298935&quot; title=&quot;fix independence bug in create_pack logic in SuperWord::find_adjacent_refs&quot; class=&quot;issue-link&quot; data-issue-key=&quot;JDK-8298935&quot;&gt;&lt;strike&gt;JDK-8298935&lt;/strike&gt;&lt;/a&gt; did not properly verify that the packs were independent.&lt;br/&gt;
But independence on pack level is not sufficient, there can still be cyclic dependencies between the packs. This bug here reveals this.&lt;br/&gt;
&lt;br/&gt;
It seems that we missed out on this, even though the SuperWord paper mentions that one has to be careful about cyclic dependencies between the (independent) packs.&lt;br/&gt;
&lt;br/&gt;
See&lt;br/&gt;
&lt;a href=&quot;https://groups.csail.mit.edu/cag/slp/SLP-PLDI-2000.pdf&quot;&gt;https://groups.csail.mit.edu/cag/slp/SLP-PLDI-2000.pdf&lt;/a&gt;&lt;br/&gt;
(3.7 Scheduling)&lt;br/&gt;
&lt;br/&gt;
See also my explanations in the PR of &lt;a href=&quot;https://bugs.openjdk.org/browse/JDK-8298935&quot; title=&quot;fix independence bug in create_pack logic in SuperWord::find_adjacent_refs&quot; class=&quot;issue-link&quot; data-issue-key=&quot;JDK-8298935&quot;&gt;&lt;strike&gt;JDK-8298935&lt;/strike&gt;&lt;/a&gt;:&lt;br/&gt;
&lt;a href=&quot;https://github.com/openjdk/jdk/pull/12350#issuecomment-1465860465&quot;&gt;https://github.com/openjdk/jdk/pull/12350#issuecomment-1465860465&lt;/a&gt;</description>
                <environment></environment>
        <key id="5096046">JDK-8304042</key>
            <summary>C2 SuperWord: schedule must remove packs with cyclic dependencies</summary>
                <type id="1" iconUrl="https://bugs.openjdk.org/secure/viewavatar?size=xsmall&amp;avatarId=14703&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://bugs.openjdk.org/images/jbsImages/p3.png">P3</priority>
                        <status id="5" iconUrl="https://bugs.openjdk.org/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="success"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="epeter">Emanuel Peter</assignee>
                                    <reporter username="epeter">Emanuel Peter</reporter>
                        <labels>
                            <label>c2-superword</label>
                            <label>oracle-triage-21</label>
                    </labels>
                <created>Mon, 13 Mar 2023 03:09:41 -0700</created>
                <updated>Mon, 10 Apr 2023 10:25:03 -0700</updated>
                            <resolved>Tue, 4 Apr 2023 21:54:55 -0700</resolved>
                                    <version>11</version>
                    <version>17</version>
                    <version>20</version>
                    <version>21</version>
                                    <fixVersion>21</fixVersion>
                                    <component>hotspot</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14571876" author="dukebot" created="Tue, 4 Apr 2023 21:54:52 -0700"  >Changeset: 83a924a1&lt;br/&gt;
Author:    Emanuel Peter &amp;lt;&lt;a href=&apos;mailto:epeter@openjdk.org&apos;&gt;epeter@openjdk.org&lt;/a&gt;&amp;gt;&lt;br/&gt;
Date:      2023-04-05 04:52:11 +0000&lt;br/&gt;
URL:       &lt;a href=&quot;https://git.openjdk.org/jdk/commit/83a924a1008853dee2ead8f6c3a82f9e3abc6125&quot;&gt;https://git.openjdk.org/jdk/commit/83a924a1008853dee2ead8f6c3a82f9e3abc6125&lt;/a&gt;&lt;br/&gt;
</comment>
                            <comment id="14569119" author="roboduke" created="Thu, 23 Mar 2023 09:01:45 -0700"  >A pull request was submitted for review.&lt;br/&gt;
URL: &lt;a href=&quot;https://git.openjdk.org/jdk/pull/13078&quot;&gt;https://git.openjdk.org/jdk/pull/13078&lt;/a&gt;&lt;br/&gt;
Date: 2023-03-17 14:34:26 +0000</comment>
                            <comment id="14567775" author="JIRAUSER19821" created="Fri, 17 Mar 2023 06:50:08 -0700"  >I found a bit more complicated case, where we even hit an assert:&lt;br/&gt;
&lt;br/&gt;
./java -XX:-TieredCompilation -Xbatch --add-modules java.base --add-exports java.base/jdk.internal.misc=ALL-UNNAMED -XX:CompileCommand=compileonly,Test3::test -XX:CompileCommand=printcompilation,Test3::* -XX:LoopUnrollLimit=250 -XX:LoopMaxUnroll=5 Test3.java&lt;br/&gt;
&lt;br/&gt;
#  Internal Error (/home/emanuel/Documents/fork6-jdk/open/src/hotspot/share/opto/loopnode.cpp:5384), pid=1933953, tid=1933966&lt;br/&gt;
#  assert(!is_visited) failed: visit only once&lt;br/&gt;
&lt;br/&gt;
in PhaseIdealLoop::build_loop_early&lt;br/&gt;
&lt;br/&gt;
In the attached picture, we can see that the IR now has cyclic dependency of data/memory nodes, but no phi node is in that cycle. This leads to an unschedulable graph. Hence the assert. I suspect that we expected to traverse a DAG, but then visited a node twice, hence we found a cycle where we did not expect it.&lt;br/&gt;
&lt;br/&gt;
The reason is still the same bug: we schedule packs that have cyclic dependencies. We now see that cyclic dependency trigger this &amp;quot;visit only once&amp;quot; assert.</comment>
                            <comment id="14567418" author="thartmann" created="Thu, 16 Mar 2023 05:04:40 -0700"  >Great, Test2.java also reproduces with JDK 11u.</comment>
                            <comment id="14567415" author="JIRAUSER19821" created="Thu, 16 Mar 2023 04:56:48 -0700"  >I found a test that reproduces on 17, and maybe much earlier. See Test2.java&lt;br/&gt;
&lt;br/&gt;
java -XX:-TieredCompilation -Xbatch --add-modules java.base --add-exports java.base/jdk.internal.misc=ALL-UNNAMED Test2.java</comment>
                            <comment id="14566300" author="thartmann" created="Mon, 13 Mar 2023 06:41:15 -0700"  >Quickly checked and the Test.java reproducer first triggers the issue after &lt;a href=&quot;https://bugs.openjdk.org/browse/JDK-8304042&quot; title=&quot;C2 SuperWord: schedule must remove packs with cyclic dependencies&quot; class=&quot;issue-link&quot; data-issue-key=&quot;JDK-8304042&quot;&gt;&lt;strike&gt;JDK-8304042&lt;/strike&gt;&lt;/a&gt; in JDK 18 which is probably just because the test relies on the conversions supported with that change. Older JDK versions should be affected as well.</comment>
                            <comment id="14566241" author="thartmann" created="Mon, 13 Mar 2023 03:19:57 -0700"  >ILW = Same as &lt;a href=&quot;https://bugs.openjdk.org/browse/JDK-8298935&quot; title=&quot;fix independence bug in create_pack logic in SuperWord::find_adjacent_refs&quot; class=&quot;issue-link&quot; data-issue-key=&quot;JDK-8298935&quot;&gt;&lt;strike&gt;JDK-8298935&lt;/strike&gt;&lt;/a&gt; = P3</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10003">
                    <name>Relates</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="5096884">JDK-8304720</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="5060436">JDK-8275317</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="5089917">JDK-8298935</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="102968" name="Test.java" size="1730" author="epeter" created="Mon, 13 Mar 2023 03:10:46 -0700"/>
                            <attachment id="103030" name="Test2.java" size="1959" author="epeter" created="Thu, 16 Mar 2023 04:56:57 -0700"/>
                            <attachment id="103042" name="Test3.IR.data.cycle.png" size="65163" author="epeter" created="Fri, 17 Mar 2023 06:50:05 -0700"/>
                            <attachment id="103041" name="Test3.java" size="3941" author="epeter" created="Fri, 17 Mar 2023 06:23:17 -0700"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_11700" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_10600" key="com.oracle.jira.javabugsystem-jira-plugin:jbs-fixedBackportedCustomfield">
                        <customfieldname>Fixed</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_11100" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i30pfn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_11004" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_10006" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Resolved In Build</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="17417"><![CDATA[b17]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_10008" key="com.oracle.jira.jira-subcomponent-plugin:oracle-subComponentField">
                        <customfieldname>Subcomponent</customfieldname>
                        <customfieldvalues>
                             <customfieldvalue key="208"><![CDATA[compiler]]></customfieldvalue> 
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_10601" key="com.oracle.jira.javabugsystem-jira-plugin:jbs-targetBackportedCustomfield">
                        <customfieldname>Targeted</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>