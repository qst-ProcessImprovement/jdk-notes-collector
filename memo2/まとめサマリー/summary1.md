OpenJDK 21.0.5から21.0.8への主要な変更点に関する技術概要

1.0 序文 (Introduction)

本レポートは、OpenJDK 21.0.6、21.0.7、および21.0.8の各アップデートで導入された累積的な変更点に関する詳細な技術概要を提供します。本文書では、JDK 21 LTS（Long-Term Support）リリースを利用する開発者およびシステム管理者に影響を与える可能性のある、重要なバグ修正、セキュリティ強化、そして注目すべき動作変更に焦点を当てています。これらのアップデートは、Javaエコシステムの安定性、安全性、パフォーマンスを維持するための継続的な取り組みを反映しています。

2.0 セキュリティ強化 (Security Enhancements)

LTSリリースにおける継続的なセキュリティメンテナンスは、Javaプラットフォームの信頼性を支える上で戦略的に極めて重要です。本セクションで解説するアップデートは、主に業界のベストプラクティスに沿った認証局（CA）の事前失効措置や、新たな脅威から保護するためのコアセキュリティコンポーネントの更新が含まれています。

2.1 ルート認証局(CA)の更新 (Root Certificate Authority (CA) Updates)

JDKのcacertsトラストストアに含まれる信頼済みルート証明書セットに対して、複数の重要な更新が行われました。これにより、TLS通信の安全性がさらに強化されます。

* EntrustルートCAの制限 (JDK-8337664)
  * Entrustが発行したルートCAによってアンカーされたTLSサーバー証明書のうち、2024年10月31日以降に発行されたものは信頼されなくなります。
* Baltimore CyberTrust Rootの削除 (JDK-8351960)
  * 2025年5月に有効期限が切れる「Baltimore CyberTrust Root」証明書がcacertsから削除されました。
* CamerfirmaルートCAの失効 (JDK-8349870, JDK-8356530)
  * CamerfirmaによってアンカーされたTLSサーバー証明書が信頼されなくなり、関連する2つのルート証明書がcacertsから削除されました。
* Sectigoルート証明書の追加 (JDK-8359349)
  * 新たに2つのTLSルート証明書と2つのコードサイニング用ルート証明書がcacertsに追加されました。

これらの変更により、失効対象のCAが発行した証明書を使用しているサーバーへのTLS接続を試みるアプリケーションは、例外を受け取る可能性があります。もし継続的な信頼が必要な場合、例えばJDK-8337664のケースでは、jdk.security.caDistrustPoliciesセキュリティプロパティから"ENTRUST_TLS"を削除することで、一時的にこの制限を回避できます。

2.2 その他のセキュリティ関連の修正 (Other Security-Related Fixes)

ルートCAの更新に加え、以下のセキュリティ堅牢化の修正も行われています。

* SecureRandomの改善 (JDK-8343046)
  * 乱数生成において、提供されたSecureRandomオブジェクトからのみ乱数が供給されるよう修正されました。これにより、暗号プロバイダが指定されたインスタンスに排他的に依存することが保証され、乱数生成プロセスの完全性と追跡可能性が向上します。
* レガシープロバイダの動作復元 (JDK-8353894)
  * レガシーなセキュリティプロバイダにおいて、無効なサービスを要求された場合にnullを返すという従来の動作が復元されました。これにより、互換性と一貫性が保たれます。

これらのセキュリティ強化は、Javaアプリケーションを保護するための重要なステップです。続いて、開発者が直接観測する可能性のあるJDKのランタイム動作の変更点について詳述します。

3.0 注目すべき動作変更と重要リグレッションの修正 (Notable Behavioral Changes and Critical Regression Fixes)

LTSリリース上でアプリケーションを維持する開発者にとって、動作変更やリグレッションの修正内容を理解することは不可欠です。本セクションでは、アプリケーションの機能に直接影響を及ぼす可能性があったり、以前のアップデートで発生した問題を解決したりする、影響の大きい修正項目を取り上げます。

3.1 による子プロセス終了の問題 (Issue with  Terminating Child Processes)

JDK 21.0.2で、Runtime.getRuntime().exec()を介して起動された子プロセスが、親であるJavaアプリケーションがSystem.exit(0)を呼び出すと意図せず終了してしまうというリグレッションが発生しました。この問題はJDK-8325203で修正され、期待される動作が復元されました。

項目	動作
期待された動作	System.exit(0)を呼び出すと、Javaアプリケーションのみが終了する。
リグレッション発生時の動作	Javaアプリケーションと、それが起動した子プロセスの両方が終了する。

3.2 Windowsにおけるモードの動作変更と差し戻し (Change and Reversion of  Mode Behavior on Windows)

Windows環境でのヘッドレスモードの検出ロジックに関する変更とその後の差し戻しが行われました。

1. 変更の導入 (JDK-8185862): 当初、仮想ディスプレイデバイスのみが存在する場合に自動的にヘッドレスモードを有効にする新しい検出ロジックが導入されました。しかし、この変更は自動テスト環境などで予期せぬ問題を引き起こしました。
2. 変更の差し戻し (JDK-8348625): この問題を受け、JDK 21uおよび17uでは、安定性を維持するためにこの変更を差し戻す決定がなされました。これにより、以前のより予測可能で互換性の高い動作が復元されています。

3.3 ForkJoinPoolの共通プールにおけるクラスアンロードの問題と修正サイクル (Class Unloading Issue in ForkJoinPool Common Pool and its Fix Cycle)

ForkJoinPoolの共通プールに関連するクラスアンロードの問題は、複数回にわたる修正サイクルを経て解決されました。

1. 根本問題 (JDK-8327501): 共通プールのワーカースレッドがAccessControlContextをキャプチャすることで、アプリケーションクラスのアンロードが妨げられ、メモリリークを引き起こす問題が特定されました。
2. 初期修正の副作用 (JDK-8328366): この問題を修正するための最初の試みは、既存のライブラリ（例: Quarkus）がThread.currentThread().setContextClassLoader(...)を呼び出した際にSecurityExceptionをスローするという、意図しないリグレッションを引き起こしました。
3. 修正版の適用 (JDK-8344993): この副作用を解決する修正がバックポートされ、最終的にクラスアンロードのリークとコンテキストクラスローダーのリグレッションの両方が解決されました。

3.4 の型アノテーション可視性に関する問題 (Issues with  Type Annotation Visibility)

javacコンパイラにおいて、型アノテーションの可視性に関する一連の複雑な問題が発生し、段階的な対応が取られました。

1. 最初の問題 (JDK-8225377, Backport: JDK-8341779): javacのプラグインが、クラスパスからロードされたシンボルの型アノテーションを認識できない問題が修正されました。
2. リグレッションの発生 (JDK-8320001, Backport: JDK-8354893): 上記の修正により、コンストラクタの戻り値型にアノテーションが付与されている場合にコンパイラがクラッシュするという新たなリグレッションが発生しました。
3. 一時的な無効化 (JDK-8360406): このコンパイラの安定性を確保するため、21.0.7リリースにおいて、問題を引き起こした型アノテーションをクラスファイルにアタッチするロジックが一時的に無効化されました。これは、複雑な問題に対して慎重なアプローチを取っていることを示しています。

アプリケーションレベルの動作変更から、次にJava Virtual Machine内部の改善点に焦点を移します。

4.0 HotSpot VMの改善 (HotSpot VM Improvements)

HotSpot VMは、Javaのパフォーマンスと信頼性の基盤です。アップデート21.0.6から21.0.8にかけて、ガベージコレクション、JITコンパイラ、ランタイム操作、およびサービスビリティ全般にわたる的を絞った修正と機能強化が提供されています。

4.1 ガベージコレクション (Garbage Collection)

各ガベージコレクタに対して、以下のような主要な修正が行われました。

* Shenandoah:
  * JFR Leak Profilerが正常に動作しない問題が修正されました (JDK-8279016, JDK-8351030)。
* ZGC:
  * ヒューリスティクスにおける「ゼロ除算」エラーを引き起こす一連の問題が修正されました (JDK-8332717, JDK-8341823, JDK-8344408, JDK-8354271)。
* G1:
  * nmethod（コンパイル済みメソッド）のカウント統計が不正確になる問題が修正されました (JDK-8343028)。

4.2 JITコンパイラ (JIT Compilers)

C2およびC1 JITコンパイラにおいて、パフォーマンスと安定性に関する重要な修正が行われました。

* C2:
  * CodeBufferにおいて_overflow_arenaが適切に解放されずメモリリークを引き起こす問題が修正されました (JDK-8284620, Redo: JDK-8346413)。
* プラットフォーム固有の改善:
  * 継続的な最適化作業の一環として、プラットフォーム固有の改善が行われています。例えば、AArch64での符号なし除算/剰余演算の組み込み関数の有効化 (JDK-8339272) や、RISC-VにおけるC言語呼び出し規約の更新 (JDK-8339397) などが含まれます。

4.3 ランタイムとサービスビリティ (Runtime and Serviceability)

JVMの診断機能とプラットフォームサポートが大幅に強化されました。

* System.mapの診断機能強化:
  * System.mapおよびSystem.dump_mapの出力が大幅に改善され、メモリマッピングごとの実メモリ使用量（RSS）、ページサイズ、THP（Transparent Huge Pages）の状態、スワップ使用量などの情報が追加されました (JDK-8322475, JDK-8326586, JDK-8351920, JDK-8354579)。これにより、コンテナ環境でのメモリフットプリントの正確な把握や、パフォーマンスに影響を与えるTransparent Huge Pagesの利用状況の確認など、本番環境における複雑なメモリ問題の診断が大幅に容易になります。
* クラッシュダンプの改善:
  * JVMがクラッシュした際に、より多くの有益な診断情報を回復・出力できるよう改善されました (JDK-8294160, JDK-8345914)。
* Windowsでのプロセッササポート拡張:
  * HotSpot VMがWindows上で64を超える論理プロセッサを利用できるようになり、最新の多コアサーバーにおけるパフォーマンスが向上しました (JDK-8341054)。

VMの内部的な改善に続き、開発者が日常的に利用するコアライブラリの修正点を見ていきます。

5.0 コアライブラリとAPIの修正 (Core Libraries and API Fixes)

コアライブラリの信頼性はJavaエコシステム全体にとって不可欠です。今回のアップデートでは、ネットワーキング、I/O、コレクション、その他の基盤となるAPIにおける重要なバグやエッジケースが修正されています。

5.1 ネットワークライブラリ (Networking Libraries)

* DatagramChannelにおいてデータグラムが失われることでテストがタイムアウトする問題が修正されました (JDK-8299813)。
* 古いDockerリリース環境において、statxシステムコールがseccompのホワイトリストに含まれていないためにFiles.readAttributesが失敗する問題が修正されました (JDK-8337966)。
* Selectorにおいて、SelectableChannelの遅延クローズに関連する競合状態が修正されました (JDK-8341941)。

5.2  and 

* 巨大なリストに対してCollections.rotateを実行した際に発生する可能性のあった整数オーバーフローが修正されました (JDK-8355760)。
* PKCS12KeyStore.engineGetEntryメソッドにおいて、マルチスレッド環境でのTLSハンドシェイク中にConcurrentModificationExceptionが発生する問題が修正されました (JDK-8355099)。
* URLConnectionがjar:fileおよびfile:形式のURLに対してgetLastModified()を呼び出した際にファイルハンドルをリークする問題が修正されました (JDK-8353096)。

これらの基盤ライブラリにおける地道な修正は、JDK 21 LTS全体の信頼性を高める上で不可欠であり、本レポートの結論へと繋がります。

6.0 結論 (Conclusion)

OpenJDK 21.0.6、21.0.7、および21.0.8にわたる一連のアップデートは、JDK 21 LTSラインの安定性、セキュリティ、およびパフォーマンスを強化するという明確なテーマを共有しています。本レポートで詳述した通り、これらのリリースは、セキュリティ基盤の強化、重要なリグレッションの修正、そしてHotSpot VMからコアライブラリに至るまでの広範な改善を含んでいます。開発者およびシステム管理者は、アップデートサイクルを計画する際に、本レポートで取り上げた注目すべき動作変更や重要な修正点を確認し、スムーズな移行を確保することが推奨されます。
