<!-- 
RSS generated by JIRA (9.12.27#9120027-sha1:edc4490121e366e9e7bd2213d532dbe7e028fc5d) at Tue Sep 30 16:57:15 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>Java Bug System</title>
    <link>https://bugs.openjdk.org</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-us</language>    <build-info>
        <version>9.12.27</version>
        <build-number>9120027</build-number>
        <build-date>02-09-2025</build-date>
    </build-info>


<item>
            <title>[JDK-8302795] Shared archive failed on old version class with jsr bytecode</title>
                <link>https://bugs.openjdk.org/browse/JDK-8302795</link>
                <project id="10100" key="JDK">JDK</project>
                    <description>CDS can archive old version class lower than version 50. Some old version class contain &amp;#39;jsr&amp;#39; which is not generated in newer version. CDS will run fail on sharing CDS with old version with &amp;#39;jsr&amp;#39;.&lt;br/&gt;
&lt;br/&gt;
Here is the simple test:&lt;br/&gt;
import org.apache.xerces.parsers.SAXParser;&lt;br/&gt;
public class SaxExample {&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;public static void main(String... args) throws Exception {&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;SAXParser parser = new SAXParser();&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;System.out.println(&amp;quot;Hello, SAXParser world!&amp;quot;);&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}&lt;br/&gt;
}&lt;br/&gt;
&lt;br/&gt;
You can get the version of xercesImpl-2.12.0.jar from here:&lt;br/&gt;
&lt;a href=&quot;https://mvnrepository.com/artifact/xerces/xercesImpl/2.12.0&quot;&gt;https://mvnrepository.com/artifact/xerces/xercesImpl/2.12.0&lt;/a&gt;&lt;br/&gt;
&lt;br/&gt;
put this jar on path, and create CDS archive, run with it then get:&lt;br/&gt;
---------------  T H R E A D  ---------------&lt;br/&gt;
&lt;br/&gt;
Current thread (0xf5918040):  JavaThread &amp;quot;main&amp;quot; [_thread_in_vm, id=17441, stack(0xf5af8000,0xf5b49000)]&lt;br/&gt;
&lt;br/&gt;
Stack: [0xf5af8000,0xf5b49000],  sp=0xf5b4796c,  free space=318k&lt;br/&gt;
Native frames: (J=compiled Java code, j=interpreted, Vv=VM code, C=native code)&lt;br/&gt;
V  [libjvm.so+0x580d94]  Array&amp;lt;Method*&amp;gt;::at_put(int, Method* const&amp;amp;)+0x68&lt;br/&gt;
V  [libjvm.so+0xca9679]  Rewriter::Rewriter(InstanceKlass*, constantPoolHandle const&amp;amp;, Array&amp;lt;Method*&amp;gt;*, JavaThread*)+0x369&lt;br/&gt;
V  [libjvm.so+0xca9289]  Rewriter::rewrite(InstanceKlass*, JavaThread*)+0x119&lt;br/&gt;
V  [libjvm.so+0x858451]  InstanceKlass::rewrite_class(JavaThread*)+0xa5&lt;br/&gt;
V  [libjvm.so+0x858141]  InstanceKlass::link_class_impl(JavaThread*)+0x3a1&lt;br/&gt;
V  [libjvm.so+0x857cfb]  InstanceKlass::link_class(JavaThread*)+0x67&lt;br/&gt;
V  [libjvm.so+0x8586cf]  InstanceKlass::initialize_impl(JavaThread*)+0x55&lt;br/&gt;
V  [libjvm.so+0x857c11]  InstanceKlass::initialize(JavaThread*)+0x2d&lt;br/&gt;
V  [libjvm.so+0xa5b853]  LinkResolver::resolve_static_call(CallInfo&amp;amp;, LinkInfo const&amp;amp;, bool, JavaThread*)+0x97&lt;br/&gt;
V  [libjvm.so+0xa5e522]  LinkResolver::resolve_invokestatic(CallInfo&amp;amp;, constantPoolHandle const&amp;amp;, int, JavaThread*)+0x50&lt;br/&gt;
V  [libjvm.so+0xa5e181]  LinkResolver::resolve_invoke(CallInfo&amp;amp;, Handle, constantPoolHandle const&amp;amp;, int, Bytecodes::Code, JavaThread*)+0x41&lt;br/&gt;
V  [libjvm.so+0x877964]  InterpreterRuntime::resolve_invoke(JavaThread*, Bytecodes::Code)+0x2b0&lt;br/&gt;
V  [libjvm.so+0x8782b0]  InterpreterRuntime::resolve_from_cache(JavaThread*, Bytecodes::Code)+0x8e&lt;br/&gt;
j  org.apache.xerces.parsers.SAXParser.&amp;lt;init&amp;gt;(Lorg/apache/xerces/util/SymbolTable;Lorg/apache/xerces/xni/grammars/XMLGrammarPool;)V+5&lt;br/&gt;
j  org.apache.xerces.parsers.SAXParser.&amp;lt;init&amp;gt;()V+3&lt;br/&gt;
j  SaxExample.main([Ljava/lang/String;)V+4&lt;br/&gt;
v  ~StubRoutines::call_stub&lt;br/&gt;
V  [libjvm.so+0x882e51]  JavaCalls::call_helper(JavaValue*, methodHandle const&amp;amp;, JavaCallArguments*, JavaThread*)+0x3eb&lt;br/&gt;
V  [libjvm.so+0xbf997b]  os::os_exception_wrapper(void (*)(JavaValue*, methodHandle const&amp;amp;, JavaCallArguments*, JavaThread*), JavaValue*, methodHandle const&amp;amp;, JavaCallArguments*, JavaThread*)+0x21&lt;br/&gt;
V  [libjvm.so+0x882a5c]  JavaCalls::call(JavaValue*, methodHandle const&amp;amp;, JavaCallArguments*, JavaThread*)+0x2e&lt;br/&gt;
V  [libjvm.so+0x9357c1]  jni_invoke_static(JNIEnv_*, JavaValue*, _jobject*, JNICallType, _jmethodID*, JNI_ArgumentPusher*, JavaThread*)+0x185&lt;br/&gt;
V  [libjvm.so+0x93feb3]  jni_CallStaticVoidMethod+0x110&lt;br/&gt;
C  [libjli.so+0x8a27]  JavaMain+0xb26&lt;br/&gt;
C  [libjli.so+0xe987]  ThreadJavaMain+0x30&lt;br/&gt;
C  [libpthread.so.0+0x6bbc]  start_thread+0xcc&lt;br/&gt;
&lt;br/&gt;
&amp;#39;jsr&amp;#39; gets rewritten then the code is wrriten back to the read only shared region.&lt;br/&gt;
&lt;br/&gt;
Maybe the fix could like this?&lt;br/&gt;
diff --git a/src/hotspot/share/interpreter/rewriter.cpp b/src/hotspot/share/interpreter/rewriter.cpp&lt;br/&gt;
index 080735ba41d..92a7af2cf0b 100644&lt;br/&gt;
--- a/src/hotspot/share/interpreter/rewriter.cpp&lt;br/&gt;
+++ b/src/hotspot/share/interpreter/rewriter.cpp&lt;br/&gt;
@@ -617,6 +617,9 @@ Rewriter::Rewriter(InstanceKlass* klass, const constantPoolHandle&amp;amp; cpool, Array&amp;lt;&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;// rewritten in the RO section of the shared archive.&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;// Relocated bytecodes don&amp;#39;t have to be restored, only the cp cache entries&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;int len = _methods-&amp;gt;length();&lt;br/&gt;
+  // Don&amp;#39;t write back to RO space for old jsr rewritten, the rewritten still&lt;br/&gt;
+  // needed for contant pool indices&lt;br/&gt;
+  bool do_update = !(UseSharedSpaces &amp;amp;&amp;amp; _klass-&amp;gt;is_shared() &amp;amp;&amp;amp; _klass-&amp;gt;major_version() &amp;lt; 50);&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;for (int i = len-1; i &amp;gt;= 0; i--) {&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;methodHandle m(THREAD, _methods-&amp;gt;at(i));&lt;br/&gt;
&lt;br/&gt;
@@ -630,7 +633,9 @@ Rewriter::Rewriter(InstanceKlass* klass, const constantPoolHandle&amp;amp; cpool, Array&amp;lt;&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;return;&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;// Method might have gotten rewritten.&lt;br/&gt;
-      methods-&amp;gt;at_put(i, m());&lt;br/&gt;
+      if (do_update) {&lt;br/&gt;
+        methods-&amp;gt;at_put(i, m());&lt;br/&gt;
+      }&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;}&lt;br/&gt;
&amp;nbsp;}&lt;br/&gt;
&amp;nbsp;</description>
                <environment></environment>
        <key id="5094526">JDK-8302795</key>
            <summary>Shared archive failed on old version class with jsr bytecode</summary>
                <type id="1" iconUrl="https://bugs.openjdk.org/secure/viewavatar?size=xsmall&amp;avatarId=14703&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://bugs.openjdk.org/images/jbsImages/p4.png">P4</priority>
                        <status id="5" iconUrl="https://bugs.openjdk.org/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="success"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ccheung">Calvin Cheung</assignee>
                                    <reporter username="minqi">Yumin Qi</reporter>
                        <labels>
                            <label>cds</label>
                            <label>verifier</label>
                    </labels>
                <created>Fri, 17 Feb 2023 12:20:23 -0800</created>
                <updated>Tue, 12 Nov 2024 08:03:56 -0800</updated>
                            <resolved>Tue, 14 Mar 2023 10:16:52 -0700</resolved>
                                    <version>21</version>
                                    <fixVersion>21</fixVersion>
                                    <component>hotspot</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="14566817" author="dukebot" created="Tue, 14 Mar 2023 10:16:50 -0700"  >Changeset: 830fd413&lt;br/&gt;
Author:    Calvin Cheung &amp;lt;&lt;a href=&apos;mailto:ccheung@openjdk.org&apos;&gt;ccheung@openjdk.org&lt;/a&gt;&amp;gt;&lt;br/&gt;
Date:      2023-03-14 17:15:19 +0000&lt;br/&gt;
URL:       &lt;a href=&quot;https://git.openjdk.org/jdk/commit/830fd413461709a494bcb81952e5c32088676ee3&quot;&gt;https://git.openjdk.org/jdk/commit/830fd413461709a494bcb81952e5c32088676ee3&lt;/a&gt;&lt;br/&gt;
</comment>
                            <comment id="14562846" author="roboduke" created="Fri, 24 Feb 2023 15:35:08 -0800"  >A pull request was submitted for review.&lt;br/&gt;
URL: &lt;a href=&quot;https://git.openjdk.org/jdk/pull/12752&quot;&gt;https://git.openjdk.org/jdk/pull/12752&lt;/a&gt;&lt;br/&gt;
Date: 2023-02-24 23:28:14 +0000</comment>
                            <comment id="14561180" author="ccheung" created="Fri, 17 Feb 2023 15:54:18 -0800"  >Some initial findings. The Method at crash:&lt;br/&gt;
&lt;br/&gt;
(gdb) print (Method)*0x800246a90&lt;br/&gt;
$19 = {&amp;lt;Metadata&amp;gt; = {&amp;lt;MetaspaceObj&amp;gt; = {&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;static _shared_metaspace_base = 0x800000000, &lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;static _shared_metaspace_top = 0x80092e000}, &lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;_vptr.Metadata = 0x800000808, _valid = 0}, _constMethod = 0x800246b00, &lt;br/&gt;
&amp;nbsp;&amp;nbsp;_method_data = 0x0, _method_counters = 0x0, _adapter = 0x0, &lt;br/&gt;
&amp;nbsp;&amp;nbsp;_access_flags = {_flags = 276824074}, _vtable_index = -4, &lt;br/&gt;
&amp;nbsp;&amp;nbsp;_intrinsic_id = 0, _flags = 0, _trace_flags = {_flags = 0}, &lt;br/&gt;
&amp;nbsp;&amp;nbsp;_compiled_invocation_count = 0, _name = 0x8004b5de0, _i2i_entry = 0x0, &lt;br/&gt;
&amp;nbsp;&amp;nbsp;_from_compiled_entry = 0x0, _code = 0x0, _from_interpreted_entry = 0x0}&lt;br/&gt;
&lt;br/&gt;
(gdb) print (ConstantPool)*0x800245510&lt;br/&gt;
$17 = {&amp;lt;Metadata&amp;gt; = {&amp;lt;MetaspaceObj&amp;gt; = {&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;static _shared_metaspace_base = 0x800000000, &lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;static _shared_metaspace_top = 0x80092e000}, &lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;_vptr.Metadata = 0x800000060, _valid = 0}, _tags = 0x800245e18, &lt;br/&gt;
&amp;nbsp;&amp;nbsp;_cache = 0x7fab844020a8, _pool_holder = 0x800245308, _operands = 0x0, &lt;br/&gt;
&amp;nbsp;&amp;nbsp;_resolved_klasses = 0x800245f38, _major_version = 47, _minor_version = 0, &lt;br/&gt;
&amp;nbsp;&amp;nbsp;_generic_signature_index = 0, _source_file_name_index = 0, _flags = 6, &lt;br/&gt;
&amp;nbsp;&amp;nbsp;_length = 279, _saved = {_resolved_reference_length = 0, _version = 0}}&lt;br/&gt;
&lt;br/&gt;
(gdb) print ((Method)*0x800246a90)._name&lt;br/&gt;
$20 = (Symbol *) 0x8004b5de0&lt;br/&gt;
(gdb) x/s &amp;amp;(((Method)*0x800246a90)._name._body)&lt;br/&gt;
0x8004b5de6:	&amp;quot;findJarServiceProvider&amp;quot;&lt;br/&gt;
&lt;br/&gt;
The method is from the following class:&lt;br/&gt;
org/apache/xerces/parsers/ObjectFactory</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10003">
                    <name>Relates</name>
                                                                <inwardlinks description="relates to">
                                                        </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_11700" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_10600" key="com.oracle.jira.javabugsystem-jira-plugin:jbs-fixedBackportedCustomfield">
                        <customfieldname>Fixed</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_11100" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i30g23:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_11004" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_10006" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Resolved In Build</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="17407"><![CDATA[b14]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_10008" key="com.oracle.jira.jira-subcomponent-plugin:oracle-subComponentField">
                        <customfieldname>Subcomponent</customfieldname>
                        <customfieldvalues>
                             <customfieldvalue key="192"><![CDATA[runtime]]></customfieldvalue> 
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_10601" key="com.oracle.jira.javabugsystem-jira-plugin:jbs-targetBackportedCustomfield">
                        <customfieldname>Targeted</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>