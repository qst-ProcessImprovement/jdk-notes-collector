<!-- 
RSS generated by JIRA (9.12.27#9120027-sha1:edc4490121e366e9e7bd2213d532dbe7e028fc5d) at Tue Sep 30 10:05:34 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>Java Bug System</title>
    <link>https://bugs.openjdk.org</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-us</language>    <build-info>
        <version>9.12.27</version>
        <build-number>9120027</build-number>
        <build-date>02-09-2025</build-date>
    </build-info>


<item>
            <title>[JDK-8313368] (fc) FileChannel.size returns 0 on block special files</title>
                <link>https://bugs.openjdk.org/browse/JDK-8313368</link>
                <project id="10100" key="JDK">JDK</project>
                    <description>ADDITIONAL SYSTEM INFORMATION :&lt;br/&gt;
OS Fedora 34&lt;br/&gt;
Java 20.0.1+9 (temurin build) (but issue seems to be relevant for 20.0.2 also)&lt;br/&gt;
&lt;br/&gt;
A DESCRIPTION OF THE PROBLEM :&lt;br/&gt;
The implementation of FileChannel.size should use ioctl(BLKGETSIZE64) for block special devices.&lt;br/&gt;
For java 20 it&amp;#39;s never called (checked with strace)&lt;br/&gt;
&lt;br/&gt;
Looks like a regression from &lt;a href=&quot;https://github.com/openjdk/jdk20/commit/48cc15602b62e81bb179ca9570a1e7d8bbf4d6df&quot;&gt;https://github.com/openjdk/jdk20/commit/48cc15602b62e81bb179ca9570a1e7d8bbf4d6df&lt;/a&gt;&lt;br/&gt;
&lt;br/&gt;
Java 19 (&lt;a href=&quot;https://github.com/openjdk/jdk19/blob/master/src/java.base/unix/native/libnio/ch/FileDispatcherImpl.c&quot;&gt;https://github.com/openjdk/jdk19/blob/master/src/java.base/unix/native/libnio/ch/FileDispatcherImpl.c&lt;/a&gt;) imports  `&amp;lt;linux/fs.h&amp;gt;` which includes definition of `BLKGETSIZE64`&lt;br/&gt;
Java 20 (&lt;a href=&quot;https://github.com/openjdk/jdk20/blob/master/src/java.base/unix/native/libnio/ch/UnixFileDispatcherImpl.c&quot;&gt;https://github.com/openjdk/jdk20/blob/master/src/java.base/unix/native/libnio/ch/UnixFileDispatcherImpl.c&lt;/a&gt;) doesn&amp;#39;t import, so BLKGETSIZE64 is never defined and ioctl is never called&lt;br/&gt;
&lt;br/&gt;
REGRESSION : Last worked in version 20&lt;br/&gt;
&lt;br/&gt;
STEPS TO FOLLOW TO REPRODUCE THE PROBLEM :&lt;br/&gt;
- create block device with non-empty size&lt;br/&gt;
- check `blockdev --getsize64 /dev/sample.block` has size not 0&lt;br/&gt;
- run `java  SizeError.java`&lt;br/&gt;
&lt;br/&gt;
EXPECTED VERSUS ACTUAL BEHAVIOR :&lt;br/&gt;
EXPECTED -&lt;br/&gt;
Prints size&lt;br/&gt;
ACTUAL -&lt;br/&gt;
Prints zero and &amp;quot;WRONG&amp;quot;&lt;br/&gt;
&lt;br/&gt;
---------- BEGIN SOURCE ----------&lt;br/&gt;
import java.io.IOException;&lt;br/&gt;
import java.nio.channels.FileChannel;&lt;br/&gt;
import java.nio.file.Path;&lt;br/&gt;
&lt;br/&gt;
public class SizeError {&lt;br/&gt;
	public static void main(String[] args) throws IOException {&lt;br/&gt;
		var ch = FileChannel.open(Path.of(&amp;quot;/dev/sample.block&amp;quot;));&lt;br/&gt;
		var size = ch.size();&lt;br/&gt;
		System.out.println(size);&lt;br/&gt;
		if (size == 0L) System.out.println(&amp;quot;WRONG&amp;quot;);&lt;br/&gt;
	}&lt;br/&gt;
}&lt;br/&gt;
---------- END SOURCE ----------&lt;br/&gt;
&lt;br/&gt;
</description>
                <environment></environment>
        <key id="5106785">JDK-8313368</key>
            <summary>(fc) FileChannel.size returns 0 on block special files</summary>
                <type id="1" iconUrl="https://bugs.openjdk.org/secure/viewavatar?size=xsmall&amp;avatarId=14703&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://bugs.openjdk.org/images/jbsImages/p4.png">P4</priority>
                        <status id="5" iconUrl="https://bugs.openjdk.org/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="success"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="bpb">Brian Burkhalter</assignee>
                                    <reporter username="webbuggrp">Webbug Group</reporter>
                        <labels>
                            <label>additional-information-received</label>
                            <label>amazon-interest</label>
                            <label>dcsaw</label>
                            <label>jdk21u-fix-SQE-ok-next</label>
                            <label>jdk21u-fix-request</label>
                            <label>jdk21u-fix-yes</label>
                            <label>regression</label>
                            <label>reproducer-yes</label>
                            <label>webbug</label>
                    </labels>
                <created>Thu, 27 Jul 2023 05:30:28 -0700</created>
                <updated>Tue, 10 Oct 2023 07:38:02 -0700</updated>
                            <resolved>Wed, 2 Aug 2023 08:29:06 -0700</resolved>
                                    <version>20</version>
                    <version>21</version>
                                    <fixVersion>22</fixVersion>
                                    <component>core-libs</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="14615907" author="roboduke" created="Wed, 4 Oct 2023 11:04:37 -0700"  >[jdk21u-fix-request] Approval Request from Brian Burkhalter&lt;br/&gt;
</comment>
                            <comment id="14615906" author="roboduke" created="Wed, 4 Oct 2023 11:04:34 -0700"  >A pull request was submitted for review.&lt;br/&gt;
URL: &lt;a href=&quot;https://git.openjdk.org/jdk21u/pull/228&quot;&gt;https://git.openjdk.org/jdk21u/pull/228&lt;/a&gt;&lt;br/&gt;
Date: 2023-10-04 17:56:32 +0000</comment>
                            <comment id="14601409" author="dukebot" created="Wed, 2 Aug 2023 08:29:05 -0700"  >Changeset: 4ba81f63&lt;br/&gt;
Author:    Brian Burkhalter &amp;lt;&lt;a href=&apos;mailto:bpb@openjdk.org&apos;&gt;bpb@openjdk.org&lt;/a&gt;&amp;gt;&lt;br/&gt;
Date:      2023-08-02 15:25:59 +0000&lt;br/&gt;
URL:       &lt;a href=&quot;https://git.openjdk.org/jdk/commit/4ba81f631f572d870d0f2c96fefe0cabc55e1841&quot;&gt;https://git.openjdk.org/jdk/commit/4ba81f631f572d870d0f2c96fefe0cabc55e1841&lt;/a&gt;&lt;br/&gt;
</comment>
                            <comment id="14600308" author="roboduke" created="Mon, 31 Jul 2023 11:22:30 -0700"  >A pull request was submitted for review.&lt;br/&gt;
URL: &lt;a href=&quot;https://git.openjdk.org/jdk/pull/15092&quot;&gt;https://git.openjdk.org/jdk/pull/15092&lt;/a&gt;&lt;br/&gt;
Date: 2023-07-31 18:16:49 +0000</comment>
                            <comment id="14600120" author="alanb" created="Sat, 29 Jul 2023 05:24:10 -0700"  >Probably not a main stream usage to have a FileChannel to a block special device but the issue is a remainder that the JDK needs a lot more tests in this area to ensure that any changes catch issues like this.</comment>
                            <comment id="14600104" author="tongwan" created="Fri, 28 Jul 2023 19:36:06 -0700"  >The observations on Ubuntu:&lt;br/&gt;
JDK 20ea+16: Passed.&lt;br/&gt;
JDK 20ea+17: Failed, 0 WRONG returned.&lt;br/&gt;
JDK 21ea+20: Failed.</comment>
                            <comment id="14600103" author="tongwan" created="Fri, 28 Jul 2023 19:33:47 -0700"  >Additional information from the submitter:&lt;br/&gt;
There are 2 options:&lt;br/&gt;
- you can use any existing block device (something like `/dev/sda`) and call java with `sudo`&lt;br/&gt;
- create new one&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;```&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;fallocate -l 10M /var/tmp/test.img&lt;br/&gt;
sudo losetup --find --show /var/tmp/test.img&lt;br/&gt;
sudo chmod 444 /dev/loop0&lt;br/&gt;
&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&#10140;  /usr/bin/java SizeError.java &lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;10485760&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&#10140; /home/evanslo/.jdks/openjdk-20.0.2/bin/java SizeError.java &lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;0&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;WRONG&lt;br/&gt;
</comment>
                            <comment id="14599795" author="tongwan" created="Thu, 27 Jul 2023 22:47:27 -0700"  >Requested more details of creating block device with non-empty size from the submitter.</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10200">
                    <name>Backport</name>
                                            <outwardlinks description="backported by">
                                        <issuelink>
            <issuekey id="5112050">JDK-8317805</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10003">
                    <name>Relates</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="5082816">JDK-8293331</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="104905" name="SizeError.java" size="364" author="tongwan" created="Fri, 28 Jul 2023 19:37:57 -0700"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_10000" key="com.atlassian.jira.plugin.system.customfieldtypes:multiselect">
                        <customfieldname>CPU</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="17008"><![CDATA[generic]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_11700" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_10600" key="com.oracle.jira.javabugsystem-jira-plugin:jbs-fixedBackportedCustomfield">
                        <customfieldname>Fixed</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10003" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Introduced In Build</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="17459"><![CDATA[b17]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_10004" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Introduced In Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="22023">20</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_10005" key="com.atlassian.jira.plugin.system.customfieldtypes:multiselect">
                        <customfieldname>OS</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="17023"><![CDATA[linux]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_11100" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i32isz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_11004" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_10006" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Resolved In Build</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="17336"><![CDATA[b09]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_10008" key="com.oracle.jira.jira-subcomponent-plugin:oracle-subComponentField">
                        <customfieldname>Subcomponent</customfieldname>
                        <customfieldvalues>
                             <customfieldvalue key="228"><![CDATA[java.nio]]></customfieldvalue> 
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_10601" key="com.oracle.jira.javabugsystem-jira-plugin:jbs-targetBackportedCustomfield">
                        <customfieldname>Targeted</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>