<!-- 
RSS generated by JIRA (9.12.27#9120027-sha1:edc4490121e366e9e7bd2213d532dbe7e028fc5d) at Tue Sep 30 18:18:24 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>Java Bug System</title>
    <link>https://bugs.openjdk.org</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-us</language>    <build-info>
        <version>9.12.27</version>
        <build-number>9120027</build-number>
        <build-date>02-09-2025</build-date>
    </build-info>


<item>
            <title>[JDK-8305529] DefaultProxySelector.select(URI) in certain cases returns a List with null element</title>
                <link>https://bugs.openjdk.org/browse/JDK-8305529</link>
                <project id="10100" key="JDK">JDK</project>
                    <description>ADDITIONAL SYSTEM INFORMATION :&lt;br/&gt;
OpenJDK Runtime Environment 11.0.18 / Linux 5.15.0-1029-kvm (amd64)&lt;br/&gt;
&lt;br/&gt;
# Environment Variables&lt;br/&gt;
http_proxy = &lt;br/&gt;
https_proxy = &lt;br/&gt;
sock_proxy = &lt;br/&gt;
&lt;br/&gt;
# System Properties&lt;br/&gt;
java.version = 11.0.18&lt;br/&gt;
java.version.date = 2023-01-17&lt;br/&gt;
java.vm.specification.name = Java Virtual Machine Specification&lt;br/&gt;
java.vm.specification.vendor = Oracle Corporation&lt;br/&gt;
java.vm.specification.version = 11&lt;br/&gt;
java.vm.vendor = Ubuntu&lt;br/&gt;
java.vm.version = 11.0.18+10-post-Ubuntu-0ubuntu122.04&lt;br/&gt;
&lt;br/&gt;
A DESCRIPTION OF THE PROBLEM :&lt;br/&gt;
The new HTTP/2 client unexpected throws NPEs on some end-users systems. The reason seems to be the existence of set but empty environment variables: http_proxy | https_proxy | sock_proxy&lt;br/&gt;
&lt;br/&gt;
&lt;br/&gt;
Here&amp;#39;s the original bug report from our customer:&lt;br/&gt;
&lt;a href=&quot;https://www.filebot.net/forums/viewtopic.php?t=13656&quot;&gt;https://www.filebot.net/forums/viewtopic.php?t=13656&lt;/a&gt;&lt;br/&gt;
&lt;br/&gt;
&lt;br/&gt;
FREQUENCY : often&lt;br/&gt;
&lt;br/&gt;
&lt;br/&gt;
</description>
                <environment></environment>
        <key id="5097441">JDK-8305529</key>
            <summary>DefaultProxySelector.select(URI) in certain cases returns a List with null element</summary>
                <type id="1" iconUrl="https://bugs.openjdk.org/secure/viewavatar?size=xsmall&amp;avatarId=14703&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://bugs.openjdk.org/images/jbsImages/p4.png">P4</priority>
                        <status id="6" iconUrl="https://bugs.openjdk.org/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="success"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jpai">Jaikiran Pai</assignee>
                                    <reporter username="webbuggrp">Webbug Group</reporter>
                        <labels>
                            <label>additional-information-received</label>
                            <label>dcsaw</label>
                            <label>reproducer-other</label>
                            <label>webbug</label>
                    </labels>
                <created>Wed, 29 Mar 2023 20:09:27 -0700</created>
                <updated>Thu, 7 Nov 2024 20:27:36 -0800</updated>
                            <resolved>Wed, 12 Apr 2023 18:32:23 -0700</resolved>
                                    <version>11</version>
                    <version>17</version>
                                    <fixVersion>21</fixVersion>
                                    <component>core-libs</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="14573455" author="dukebot" created="Wed, 12 Apr 2023 18:32:21 -0700"  >Changeset: 3f36dd81&lt;br/&gt;
Author:    Jaikiran Pai &amp;lt;&lt;a href=&apos;mailto:jpai@openjdk.org&apos;&gt;jpai@openjdk.org&lt;/a&gt;&amp;gt;&lt;br/&gt;
Date:      2023-04-13 01:30:00 +0000&lt;br/&gt;
URL:       &lt;a href=&quot;https://git.openjdk.org/jdk/commit/3f36dd811e56ecb4b7c6bf1bf8be8a8de9481ed0&quot;&gt;https://git.openjdk.org/jdk/commit/3f36dd811e56ecb4b7c6bf1bf8be8a8de9481ed0&lt;/a&gt;&lt;br/&gt;
</comment>
                            <comment id="14573026" author="roboduke" created="Tue, 11 Apr 2023 04:34:02 -0700"  >A pull request was submitted for review.&lt;br/&gt;
Branch: master&lt;br/&gt;
URL: &lt;a href=&quot;https://git.openjdk.org/jdk/pull/13424&quot;&gt;https://git.openjdk.org/jdk/pull/13424&lt;/a&gt;&lt;br/&gt;
Date: 2023-04-11 11:24:55 +0000</comment>
                            <comment id="14573020" author="jpai" created="Tue, 11 Apr 2023 03:56:36 -0700"  >Thank you for the detailed report and the investigation of this issue in the linked forum threads.&lt;br/&gt;
&lt;br/&gt;
There&amp;#39;s more than one issue across different libraries here. The JDK has a bug where in its *nix implementation of the DefaultProxySelector, it can sometimes end up returning an array with null element in it, which then causes this NullPointerException. That bug is trivially reproducible when one of the proxy related environment variables is set to an incorrect (but non-empty value) and the java.net.useSystemProxies system property is set to true. I was able to reproduce this one easily.&lt;br/&gt;
&lt;br/&gt;
The other part to this issue is that, the reporter notes that the users have been hitting this issue when the proxy related environment variables are set to empty values and java.net.useSystemProxies system property is set to true. The linked forum threads indeed show that the values are empty, like this snippet from one of those logs in that forum:&lt;br/&gt;
&lt;br/&gt;
...&lt;br/&gt;
SYSTEMD_EXEC_PID = 25216&lt;br/&gt;
USER = qbtuser&lt;br/&gt;
http_proxy = &lt;br/&gt;
https_proxy = &lt;br/&gt;
sock_proxy = &lt;br/&gt;
# Java System Properties&lt;br/&gt;
....&lt;br/&gt;
&lt;br/&gt;
However, I haven&amp;#39;t able to reproduce this issue with empty values. To be sure that the fix I propose would indeed fix this issue, I looked at the underlying library&amp;#39;s code that the JDK uses (glib-2.0, whose source is here &lt;a href=&quot;https://gitlab.gnome.org/GNOME/glib)&quot;&gt;https://gitlab.gnome.org/GNOME/glib)&lt;/a&gt;. It appears that as recently as around 9 months back there was a fix made to make sure that this library skips/ignores empty values for such environment variables &lt;a href=&quot;https://gitlab.gnome.org/GNOME/glib/-/commit/6f83f45db4b859839b81f07cc942a49834663ffc&quot;&gt;https://gitlab.gnome.org/GNOME/glib/-/commit/6f83f45db4b859839b81f07cc942a49834663ffc&lt;/a&gt;. Before this fix, it appears that the library would use these empty values and then raise errors later on, which then the JDK code would ignore (that&amp;#39;s the bug in the JDK). That explains why I couldn&amp;#39;t reproduce this issue with empty values - the system where I&amp;#39;m testing this, is on version 2.72.4 of this glib-2.0 library and this version has that fix.&lt;br/&gt;
&lt;br/&gt;
It&amp;#39;s likely that the users that are running into this issue, on that forum, are on a different version of glib-2.0 library which doesn&amp;#39;t have the fix to ignore empty values and that&amp;#39;s then triggering the JDK bug.&lt;br/&gt;
&amp;nbsp;</comment>
                            <comment id="14572633" author="tongwan" created="Sun, 9 Apr 2023 18:29:56 -0700"  >Additional information from the submitter:&lt;br/&gt;
JDK11 and JDK17 on Desktop Linux with Gnome Desktop Manager. Possibly an issue with GConf behaving strange in some odd environments, and then tripping the JDK with unexpected null values.&lt;br/&gt;
&lt;br/&gt;
Reproducible for some of our customers, but we haven&amp;#39;t been able to reproduce the issue in VMs or docker environments:&lt;br/&gt;
&lt;a href=&quot;https://www.filebot.net/forums/viewtopic.php?t=13656&quot;&gt;https://www.filebot.net/forums/viewtopic.php?t=13656&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://www.filebot.net/forums/viewtopic.php?t=13678&quot;&gt;https://www.filebot.net/forums/viewtopic.php?t=13678&lt;/a&gt;&lt;br/&gt;
&lt;br/&gt;
A DESCRIPTION OF THE PROBLEM :&lt;br/&gt;
The new HTTP/2 client fails with an NPE in internal JDK code if the code is running in a oddly configured Linux environment, with set but empty proxy environment variable AND java.net.useSystemProxies=true enabled via Java System Properties.&lt;br/&gt;
&lt;br/&gt;
$ printenv | grep proxy&lt;br/&gt;
https_proxy=&lt;br/&gt;
sock_proxy=&lt;br/&gt;
http_proxy=&lt;br/&gt;
&lt;br/&gt;
The NPE originates from this line in HttpRequestImpl::retrieveProxy with the following exception message: Cannot invoke &amp;quot;java.net.Proxy.type()&amp;quot; because &amp;quot;&amp;lt;local4&amp;gt;&amp;quot; is null&lt;br/&gt;
&lt;a href=&quot;https://github.com/openjdk/jdk20u/blob/master/src/java.net.http/share/classes/jdk/internal/net/http/HttpRequestImpl.java#L304&quot;&gt;https://github.com/openjdk/jdk20u/blob/master/src/java.net.http/share/classes/jdk/internal/net/http/HttpRequestImpl.java#L304&lt;/a&gt;&lt;br/&gt;
&lt;br/&gt;
My guess is that the native Proxy[] DefaultProxySelector::getSystemProxies method somehow returns a Proxy array that is not null, but unexpectedly contains null elements for some reason:&lt;br/&gt;
&lt;a href=&quot;https://github.com/openjdk/jdk/blob/master/src/java.base/unix/native/libnet/DefaultProxySelector.c#L460&quot;&gt;https://github.com/openjdk/jdk/blob/master/src/java.base/unix/native/libnet/DefaultProxySelector.c#L460&lt;/a&gt;&lt;br/&gt;
&lt;br/&gt;
STEPS TO FOLLOW TO REPRODUCE THE PROBLEM :&lt;br/&gt;
Sorry, I was *not* able to reproduce the issue on various Desktop Linux machines using the following test case:&lt;br/&gt;
&lt;br/&gt;
groovy -Djava.net.useSystemProxies=true -e &amp;#39;println java.net.http.HttpClient.newHttpClient().send(java.net.http.HttpRequest.newBuilder().uri(new URI(&amp;quot;&lt;a href=&quot;https://bugs.java.com/bugdatabase/&quot;&gt;https://bugs.java.com/bugdatabase/&lt;/a&gt;&amp;quot;)).GET().build(),java.net.http.HttpResponse.BodyHandlers.ofString())&amp;#39;&lt;br/&gt;
&lt;br/&gt;
So this test case is untested, because so far it&amp;#39;s worked as expected and I haven&amp;#39;t actually managed to reproduce the issue reported by customers.&lt;br/&gt;
&lt;br/&gt;
EXPECTED VERSUS ACTUAL BEHAVIOR :&lt;br/&gt;
EXPECTED -&lt;br/&gt;
JDK internals should never throw NPEs. Perhaps an extra .filter(Objects::notNull) here would be good just in case:&lt;br/&gt;
&lt;a href=&quot;https://github.com/openjdk/jdk20u/blob/master/src/java.base/share/classes/sun/net/spi/DefaultProxySelector.java#L322&quot;&gt;https://github.com/openjdk/jdk20u/blob/master/src/java.base/share/classes/sun/net/spi/DefaultProxySelector.java#L322&lt;/a&gt;&lt;br/&gt;
&lt;br/&gt;
CUSTOMER SUBMITTED WORKAROUND :&lt;br/&gt;
Using -DuseSystemProxies=false resolves the issue. This is also default in the JDK, so it&amp;#39;s probably not an issue for most JDK users.&lt;br/&gt;
&lt;br/&gt;
FREQUENCY : always&lt;br/&gt;
</comment>
                            <comment id="14571983" author="tongwan" created="Wed, 5 Apr 2023 06:16:01 -0700"  >Additional information from the submitter:&lt;br/&gt;
The issue affects both JDK11 and JDK17, and up probably.&lt;br/&gt;
&lt;br/&gt;
We were able to further narrow down the issue to -Djava.net.useSystemProxies=true being set in combination with invalid system proxy (i.e. set but empty environment variables) settings:&lt;br/&gt;
&lt;a href=&quot;https://www.filebot.net/forums/viewtopic.php?p=59805#p59805&quot;&gt;https://www.filebot.net/forums/viewtopic.php?p=59805#p59805&lt;/a&gt;&lt;br/&gt;
&lt;br/&gt;
The NPE likely originates from this line here because testing on JDK the NPE gives additional information: Cannot invoke &amp;quot;java.net.Proxy.type()&amp;quot; because &amp;quot;&amp;lt;local4&amp;gt;&amp;quot; is null&lt;br/&gt;
&lt;a href=&quot;https://github.com/openjdk/jdk20u/blob/master/src/java.net.http/share/classes/jdk/internal/net/http/HttpRequestImpl.java#L304&quot;&gt;https://github.com/openjdk/jdk20u/blob/master/src/java.net.http/share/classes/jdk/internal/net/http/HttpRequestImpl.java#L304&lt;/a&gt;&lt;br/&gt;
&lt;br/&gt;
My guess is that the native Proxy[] DefaultProxySelector::getSystemProxies method somehow returns a Proxy array that is not null, but unexpectedly contains null elements for some reason:&lt;br/&gt;
&lt;a href=&quot;https://github.com/openjdk/jdk/blob/master/src/java.base/unix/native/libnet/DefaultProxySelector.c#L460&quot;&gt;https://github.com/openjdk/jdk/blob/master/src/java.base/unix/native/libnet/DefaultProxySelector.c#L460&lt;/a&gt;&lt;br/&gt;
&lt;br/&gt;
</comment>
                            <comment id="14571590" author="tongwan" created="Tue, 4 Apr 2023 02:12:11 -0700"  >Additional information from the submitter:&lt;br/&gt;
I&amp;#39;m currently unable to make a reproducible test case because I&amp;#39;m on macOS / JDK17 and cannot reproduce the issue here in my environment.  The error does suggest the issue originates from JDK internals though, though I don&amp;#39;t know what the code for Linux / JDK11 would look like specifically there.</comment>
                            <comment id="14570703" author="tongwan" created="Thu, 30 Mar 2023 06:59:24 -0700"  >Requested a simple Java reproducer from the submitter.</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10003">
                    <name>Relates</name>
                                            <outwardlinks description="relates to">
                                                        </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_10000" key="com.atlassian.jira.plugin.system.customfieldtypes:multiselect">
                        <customfieldname>CPU</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="19000"><![CDATA[x86_64]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_11700" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_10600" key="com.oracle.jira.javabugsystem-jira-plugin:jbs-fixedBackportedCustomfield">
                        <customfieldname>Fixed</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_10005" key="com.atlassian.jira.plugin.system.customfieldtypes:multiselect">
                        <customfieldname>OS</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="17023"><![CDATA[linux]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_11100" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i30y1n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_11004" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_10006" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Resolved In Build</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="17414"><![CDATA[b19]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_10008" key="com.oracle.jira.jira-subcomponent-plugin:oracle-subComponentField">
                        <customfieldname>Subcomponent</customfieldname>
                        <customfieldvalues>
                             <customfieldvalue key="193"><![CDATA[java.net]]></customfieldvalue> 
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_10601" key="com.oracle.jira.javabugsystem-jira-plugin:jbs-targetBackportedCustomfield">
                        <customfieldname>Targeted</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_10100" key="com.atlassian.jira.plugin.system.customfieldtypes:radiobuttons">
                        <customfieldname>Verification</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="17000"><![CDATA[Verified]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>