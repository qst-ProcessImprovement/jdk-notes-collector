<!-- 
RSS generated by JIRA (9.12.27#9120027-sha1:edc4490121e366e9e7bd2213d532dbe7e028fc5d) at Tue Sep 30 16:52:20 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>Java Bug System</title>
    <link>https://bugs.openjdk.org</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-us</language>    <build-info>
        <version>9.12.27</version>
        <build-number>9120027</build-number>
        <build-date>02-09-2025</build-date>
    </build-info>


<item>
            <title>[JDK-8302652] [SuperWord] Reduction should happen after loop, when possible</title>
                <link>https://bugs.openjdk.org/browse/JDK-8302652</link>
                <project id="10100" key="JDK">JDK</project>
                    <description>Currently, we do all reductions inside the loop. This makes sense for floating-point Add and Mul, where the order of reduction must be strictly linear, so as not to violate IEEE specification (basically the rounding would be ever so slightly different, and lead to wrong results).&lt;br/&gt;
&lt;br/&gt;
Pseudocode:&lt;br/&gt;
&lt;br/&gt;
acc = init&lt;br/&gt;
For (i ...) {&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;vec = &amp;quot;some vector ops&amp;quot;; // vec holds vector of results from this iteration&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;vector_reduction(vec, acc); // reduces vector vec into scalar accumulator acc&lt;br/&gt;
}&lt;br/&gt;
// use acc&lt;br/&gt;
&lt;br/&gt;
However, in integer-reductions, and some floating-point reductions that do not require the linear order (Min / Max), we can do better. We can use a vector-accumulator in the loop, and do the reduction on this vector only after the loop. This should significantly reduce the work per loop iteration.&lt;br/&gt;
&lt;br/&gt;
v_acc = scalar_to_vector(init); // depends on reduction op how we would do this&lt;br/&gt;
For (i ...) {&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;vec = &amp;quot;some vector ops&amp;quot;; // vec holds vector of results from this iteration&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;v_acc = vector_elememt_wise_reduction(v_acc, vec);&lt;br/&gt;
}&lt;br/&gt;
acc = vector_reduction(v_acc);&lt;br/&gt;
// use acc&lt;br/&gt;
&lt;br/&gt;
Note: we already have different reduction implementations.&lt;br/&gt;
We already do a &amp;quot;recursive folding&amp;quot; for ints (C2_MacroAssembler::reduce8I), and a &amp;quot;linear folding&amp;quot; for floats (C2_MacroAssembler::reduce8F).&lt;br/&gt;
&lt;a href=&quot;https://github.com/openjdk/jdk/blob/db1b48ef3bb4f8f0fbb6879200c0655b7fe006eb/src/hotspot/cpu/x86/c2_MacroAssembler_x86.cpp#L1895-L1941&quot;&gt;https://github.com/openjdk/jdk/blob/db1b48ef3bb4f8f0fbb6879200c0655b7fe006eb/src/hotspot/cpu/x86/c2_MacroAssembler_x86.cpp#L1895-L1941&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://github.com/openjdk/jdk/blob/db1b48ef3bb4f8f0fbb6879200c0655b7fe006eb/src/hotspot/cpu/x86/c2_MacroAssembler_x86.cpp#L2096-L2120&quot;&gt;https://github.com/openjdk/jdk/blob/db1b48ef3bb4f8f0fbb6879200c0655b7fe006eb/src/hotspot/cpu/x86/c2_MacroAssembler_x86.cpp#L2096-L2120&lt;/a&gt;&lt;br/&gt;
&lt;br/&gt;
I found this while working on &lt;a href=&quot;https://bugs.openjdk.org/browse/JDK-8302139&quot; title=&quot;Speed up SuperWord reduction tests&quot; class=&quot;issue-link&quot; data-issue-key=&quot;JDK-8302139&quot;&gt;&lt;strike&gt;JDK-8302139&lt;/strike&gt;&lt;/a&gt;, where I implemented an IR test for SuperWord reductions, and checked out the generated code.</description>
                <environment></environment>
        <key id="5094345">JDK-8302652</key>
            <summary>[SuperWord] Reduction should happen after loop, when possible</summary>
                <type id="7" iconUrl="https://bugs.openjdk.org/secure/viewavatar?size=xsmall&amp;avatarId=14707&amp;avatarType=issuetype">Enhancement</type>
                                            <priority id="4" iconUrl="https://bugs.openjdk.org/images/jbsImages/p4.png">P4</priority>
                        <status id="5" iconUrl="https://bugs.openjdk.org/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="success"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="epeter">Emanuel Peter</assignee>
                                    <reporter username="epeter">Emanuel Peter</reporter>
                        <labels>
                            <label>c2-superword</label>
                            <label>performance</label>
                    </labels>
                <created>Thu, 16 Feb 2023 04:19:00 -0800</created>
                <updated>Fri, 29 Nov 2024 03:13:47 -0800</updated>
                            <resolved>Tue, 23 May 2023 01:07:05 -0700</resolved>
                                    <version>21</version>
                                    <fixVersion>21</fixVersion>
                                    <component>hotspot</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="14583564" author="dukebot" created="Tue, 23 May 2023 01:07:04 -0700"  >Changeset: 06b0a5e0&lt;br/&gt;
Author:    Emanuel Peter &amp;lt;&lt;a href=&apos;mailto:epeter@openjdk.org&apos;&gt;epeter@openjdk.org&lt;/a&gt;&amp;gt;&lt;br/&gt;
Date:      2023-05-23 08:05:13 +0000&lt;br/&gt;
URL:       &lt;a href=&quot;https://git.openjdk.org/jdk/commit/06b0a5e03852dfed9f1dee4791fc71b4e4e1eeda&quot;&gt;https://git.openjdk.org/jdk/commit/06b0a5e03852dfed9f1dee4791fc71b4e4e1eeda&lt;/a&gt;&lt;br/&gt;
</comment>
                            <comment id="14579298" author="roboduke" created="Fri, 5 May 2023 00:36:07 -0700"  >A pull request was submitted for review.&lt;br/&gt;
URL: &lt;a href=&quot;https://git.openjdk.org/jdk/pull/13056&quot;&gt;https://git.openjdk.org/jdk/pull/13056&lt;/a&gt;&lt;br/&gt;
Date: 2023-03-16 07:29:44 +0000</comment>
                            <comment id="14567178" author="JIRAUSER19821" created="Wed, 15 Mar 2023 09:57:54 -0700"  >I have a WIP patch, and I see some improvements in some of my benchmarks. I will continue working on this.&lt;br/&gt;
&lt;br/&gt;
My current approach is via IGVN.</comment>
                            <comment id="14566705" author="JIRAUSER19821" created="Tue, 14 Mar 2023 04:38:24 -0700"  >I added a simple test case with int addition reduction.&lt;br/&gt;
&lt;br/&gt;
./java -Xbatch -XX:CompileCommand=compileonly,Test::test -XX:CompileCommand=print,Test::test -XX:+TraceNewVectors -XX:+TraceSuperWord Test.java&lt;br/&gt;
&lt;br/&gt;
I drew the current before/after picture, to better understand the current graph. This was the commandline:&lt;br/&gt;
./java -Xbatch -XX:CompileCommand=compileonly,Test::test -XX:CompileCommand=print,Test::testx -XX:+TraceNewVectors -XX:+TraceSuperWord -XX:+TraceLoopOpts -XX:LoopMaxUnroll=5 Test.java</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10000">
                    <name>Blocks</name>
                                                                <inwardlinks description="is blocked by">
                                        <issuelink>
            <issuekey id="5093745">JDK-8302139</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10003">
                    <name>Relates</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="5103292">JDK-8310130</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="5094358">JDK-8302662</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="5100196">JDK-8307516</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="5102726">JDK-8309647</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="5145099">JDK-8345245</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="5100194">JDK-8307513</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="5108416">JDK-8314612</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="102998" name="Test.java" size="589" author="epeter" created="Tue, 14 Mar 2023 04:38:22 -0700"/>
                            <attachment id="102999" name="int-red-0-before.png" size="66532" author="epeter" created="Tue, 14 Mar 2023 05:01:47 -0700"/>
                            <attachment id="103000" name="int-red-1-after.png" size="43635" author="epeter" created="Tue, 14 Mar 2023 05:01:47 -0700"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_11700" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_10600" key="com.oracle.jira.javabugsystem-jira-plugin:jbs-fixedBackportedCustomfield">
                        <customfieldname>Fixed</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_11100" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i30exv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_11004" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_10006" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Resolved In Build</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="17436"><![CDATA[b24]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_10008" key="com.oracle.jira.jira-subcomponent-plugin:oracle-subComponentField">
                        <customfieldname>Subcomponent</customfieldname>
                        <customfieldvalues>
                             <customfieldvalue key="208"><![CDATA[compiler]]></customfieldvalue> 
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_10601" key="com.oracle.jira.javabugsystem-jira-plugin:jbs-targetBackportedCustomfield">
                        <customfieldname>Targeted</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>