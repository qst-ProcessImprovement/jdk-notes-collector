<!-- 
RSS generated by JIRA (9.12.27#9120027-sha1:edc4490121e366e9e7bd2213d532dbe7e028fc5d) at Tue Sep 30 15:22:07 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>Java Bug System</title>
    <link>https://bugs.openjdk.org</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-us</language>    <build-info>
        <version>9.12.27</version>
        <build-number>9120027</build-number>
        <build-date>02-09-2025</build-date>
    </build-info>


<item>
            <title>[JDK-8299571] ZoneRulesProvider.registerProvider() can leave inconsistent state on failure</title>
                <link>https://bugs.openjdk.org/browse/JDK-8299571</link>
                <project id="10100" key="JDK">JDK</project>
                    <description>ADDITIONAL SYSTEM INFORMATION :&lt;br/&gt;
openjdk version &amp;quot;21-ea&amp;quot; 2023-09-19&lt;br/&gt;
OpenJDK Runtime Environment (build 21-ea+3-124)&lt;br/&gt;
OpenJDK 64-Bit Server VM (build 21-ea+3-124, mixed mode, sharing)&lt;br/&gt;
&lt;br/&gt;
A DESCRIPTION OF THE PROBLEM :&lt;br/&gt;
When registering a `java.time.zone.ZoneRulesProvider` via the `registerProvider()` method the call can fail when a zone id is already registered with another provider. The zone ids of the provider are registered one by one until the first failure. The thrown `ZoneRulesException` then prevents subsequent update code of `ZONE_IDS` and `PROVIDERS` to run and update the caches leaving the whole class in an inconsistent state where some new zone ids are registered but not given out with `getAvailableZoneIds()`.&lt;br/&gt;
&lt;br/&gt;
STEPS TO FOLLOW TO REPRODUCE THE PROBLEM :&lt;br/&gt;
Register a ZoneRulesProvider with new zone id and already registered zone id.&lt;br/&gt;
It will fail with an exception but the new zone id will nevertheless be registered with the provider but not appear in aviabale zone ids.&lt;br/&gt;
&lt;br/&gt;
EXPECTED VERSUS ACTUAL BEHAVIOR :&lt;br/&gt;
EXPECTED -&lt;br/&gt;
Either the registering needs to fail completely, then neither of `ZONE_IDS`, `PROVIDERS` nor `ZONES` are allowed to change and also none of the ZoneIds are then available XOR the registering can fail for single zone ids but non-present are registered and all caches are updated properly&lt;br/&gt;
ACTUAL -&lt;br/&gt;
New zone ids are registered but caches are not updated.&lt;br/&gt;
&lt;br/&gt;
---------- BEGIN SOURCE ----------&lt;br/&gt;
import java.time.zone.*;&lt;br/&gt;
import java.time.*;&lt;br/&gt;
import java.util.*;&lt;br/&gt;
public class ZoneRulesProviderTest {&lt;br/&gt;
&amp;nbsp;&amp;nbsp;static abstract class CustomZoneRulesProvider extends ZoneRulesProvider {&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;public ZoneRules provideRules(String zoneId, boolean forCaching){ return null; }&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;public NavigableMap&amp;lt;String, ZoneRules&amp;gt; provideVersions(String zoneId) { return new TreeMap&amp;lt;&amp;gt;(); }&lt;br/&gt;
&amp;nbsp;&amp;nbsp;}&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&lt;br/&gt;
&amp;nbsp;&amp;nbsp;public static void main(String... args) {&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;br/&gt;
&amp;nbsp;&amp;nbsp;Set&amp;lt;String&amp;gt; zoneIds = new LinkedHashSet&amp;lt;&amp;gt;();&lt;br/&gt;
&amp;nbsp;&amp;nbsp;zoneIds.add(&amp;quot;MyZoneId&amp;quot;); zoneIds.add(&amp;quot;CET&amp;quot;);&lt;br/&gt;
&amp;nbsp;&amp;nbsp;try {&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;ZoneRulesProvider.registerProvider(new CustomZoneRulesProvider() {&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;public Set&amp;lt;String&amp;gt; provideZoneIds() { return zoneIds; }&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;});&lt;br/&gt;
&amp;nbsp;&amp;nbsp;} catch(ZoneRulesException e) { e.printStackTrace(); } // Unable to register zone as one already registered with that ID: CET&lt;br/&gt;
&amp;nbsp;&amp;nbsp;ZoneId.getAvailableZoneIds().contains(&amp;quot;MyZoneId&amp;quot;); // false&lt;br/&gt;
&amp;nbsp;&amp;nbsp;ZoneId.of(&amp;quot;MyZoneId&amp;quot;); // returns a ZoneId, no exception&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&lt;br/&gt;
&amp;nbsp;&amp;nbsp;// now registering another Provider will update the ZONE_IDS cache&lt;br/&gt;
&amp;nbsp;&amp;nbsp;ZoneRulesProvider.registerProvider(new CustomZoneRulesProvider() {&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;public Set&amp;lt;String&amp;gt; provideZoneIds() { return Set.of(&amp;quot;AnotherZoneId&amp;quot;); }&lt;br/&gt;
&amp;nbsp;&amp;nbsp;});&lt;br/&gt;
&amp;nbsp;&amp;nbsp;ZoneId.getAvailableZoneIds().contains(&amp;quot;MyZoneId&amp;quot;); // true&lt;br/&gt;
&amp;nbsp;&amp;nbsp;ZoneId.getAvailableZoneIds().contains(&amp;quot;AnotherZoneId&amp;quot;); // true&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&lt;br/&gt;
&amp;nbsp;&amp;nbsp;ZoneRulesProvider.refresh(); // will not call the first Provider as it is not stored in PROVIDERS&lt;br/&gt;
}}&lt;br/&gt;
---------- END SOURCE ----------&lt;br/&gt;
&lt;br/&gt;
CUSTOMER SUBMITTED WORKAROUND :&lt;br/&gt;
Register another ZoneRulesProvider to force at least an update of the cached `ZONE_IDS`.&lt;br/&gt;
&lt;br/&gt;
FREQUENCY : always&lt;br/&gt;
&lt;br/&gt;
&lt;br/&gt;
</description>
                <environment></environment>
        <key id="5090618">JDK-8299571</key>
            <summary>ZoneRulesProvider.registerProvider() can leave inconsistent state on failure</summary>
                <type id="1" iconUrl="https://bugs.openjdk.org/secure/viewavatar?size=xsmall&amp;avatarId=14703&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://bugs.openjdk.org/images/jbsImages/p4.png">P4</priority>
                        <status id="6" iconUrl="https://bugs.openjdk.org/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="success"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="naoto">Naoto Sato</assignee>
                                    <reporter username="webbuggrp">Webbug Group</reporter>
                        <labels>
                            <label>21ea</label>
                            <label>dcsaw</label>
                            <label>reproducer-yes</label>
                            <label>webbug</label>
                    </labels>
                <created>Tue, 3 Jan 2023 06:54:42 -0800</created>
                <updated>Fri, 4 Aug 2023 12:48:48 -0700</updated>
                            <resolved>Wed, 11 Jan 2023 09:04:01 -0800</resolved>
                                    <version>21</version>
                                    <fixVersion>21</fixVersion>
                                    <component>core-libs</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="14550406" author="dukebot" created="Wed, 11 Jan 2023 09:03:59 -0800"  >Changeset: c7716a01&lt;br/&gt;
Author:    Naoto Sato &amp;lt;&lt;a href=&apos;mailto:naoto@openjdk.org&apos;&gt;naoto@openjdk.org&lt;/a&gt;&amp;gt;&lt;br/&gt;
Date:      2023-01-11 17:01:48 +0000&lt;br/&gt;
URL:       &lt;a href=&quot;https://git.openjdk.org/jdk/commit/c7716a0101d337ec75ffdbcc3d18058a03c2373f&quot;&gt;https://git.openjdk.org/jdk/commit/c7716a0101d337ec75ffdbcc3d18058a03c2373f&lt;/a&gt;&lt;br/&gt;
</comment>
                            <comment id="14550020" author="roboduke" created="Tue, 10 Jan 2023 09:25:51 -0800"  >A pull request was submitted for review.&lt;br/&gt;
URL: &lt;a href=&quot;https://git.openjdk.org/jdk/pull/11928&quot;&gt;https://git.openjdk.org/jdk/pull/11928&lt;/a&gt;&lt;br/&gt;
Date: 2023-01-10 17:17:41 +0000</comment>
                            <comment id="14549330" author="naoto" created="Fri, 6 Jan 2023 11:23:19 -0800"  >Since it is spec&amp;#39;ed to throw a `ZoneRulesException` on a duplicated zone, the registration should fail without any zones from the provider.</comment>
                            <comment id="14548579" author="tongwan" created="Tue, 3 Jan 2023 22:31:56 -0800"  >The observations on Windows 10:&lt;br/&gt;
JDK 21ea+3: Passed.  ZoneRulesException thrown.</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10003">
                    <name>Relates</name>
                                                                <inwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="5094617">JDK-8302983</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="102199" name="ZoneRulesProviderTest.java" size="1511" author="tongwan" created="Tue, 3 Jan 2023 22:30:53 -0800"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_10000" key="com.atlassian.jira.plugin.system.customfieldtypes:multiselect">
                        <customfieldname>CPU</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="17008"><![CDATA[generic]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_11700" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_10600" key="com.oracle.jira.javabugsystem-jira-plugin:jbs-fixedBackportedCustomfield">
                        <customfieldname>Fixed</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_10005" key="com.atlassian.jira.plugin.system.customfieldtypes:multiselect">
                        <customfieldname>OS</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="17010"><![CDATA[generic]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_11100" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2zrxv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_11004" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_10006" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Resolved In Build</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="17315"><![CDATA[b05]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_10008" key="com.oracle.jira.jira-subcomponent-plugin:oracle-subComponentField">
                        <customfieldname>Subcomponent</customfieldname>
                        <customfieldvalues>
                             <customfieldvalue key="697"><![CDATA[java.time]]></customfieldvalue> 
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_10601" key="com.oracle.jira.javabugsystem-jira-plugin:jbs-targetBackportedCustomfield">
                        <customfieldname>Targeted</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_10100" key="com.atlassian.jira.plugin.system.customfieldtypes:radiobuttons">
                        <customfieldname>Verification</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="17000"><![CDATA[Verified]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                </customfields>
    </item>
</channel>
</rss>